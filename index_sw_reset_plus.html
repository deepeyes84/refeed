<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>서비스워커/캐시 초기화 도구</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root {
      --fg: #0f172a;
      --muted: #475569;
      --ok: #16a34a;
      --warn: #ca8a04;
      --bg: #f8fafc;
      --card: #ffffff;
      --bd: #e5e7eb;
    }
    html, body { height: 100%; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, sans-serif; background: var(--bg); color: var(--fg); }
    .wrap { display: grid; place-items: center; min-height: 100%; padding: 24px; }
    .card { width: 100%; max-width: 720px; background: var(--card); border: 1px solid var(--bd); border-radius: 16px; padding: 20px 24px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    h1 { margin: 0 0 8px; font-size: 20px; }
    p { margin: 6px 0; color: var(--muted); }
    .log { margin-top: 12px; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 13px; max-height: 240px; overflow: auto; }
    .row { display: flex; align-items: center; gap: 8px; }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: #cbd5e1; }
    .dot.ok { background: var(--ok); }
    .dot.warn { background: var(--warn); }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 16px; }
    button, a.btn {
      appearance: none; border: 1px solid var(--bd); background: #fff; padding: 10px 14px; border-radius: 10px; cursor: pointer;
      text-decoration: none; color: var(--fg); font-size: 14px;
    }
    button.primary, a.btn.primary { background: #111827; color: #fff; border-color: #111827; }
    .hidden { display: none; }
    .done { color: var(--ok); font-weight: 600; }
    .warntext { color: var(--warn); }
    .muted { color: var(--muted); }
    .small { font-size: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>서비스워커/캐시 초기화</h1>
      <p>이 도구는 이 도메인에서 등록된 <b>Service Worker</b>를 해제하고, <b>Cache Storage</b> / <b>localStorage</b> / <b>sessionStorage</b> 를 삭제합니다.</p>
      <div id="status" class="row small"><span class="dot" id="dot"></span><span id="statusText">대기 중…</span></div>
      <div class="log" id="log" aria-live="polite"></div>
      <div class="btns">
        <button id="runBtn" class="primary">초기화 실행</button>
        <a id="reloadBtn" class="btn hidden" href="#">메인으로 이동</a>
        <button id="reRunBtn" class="hidden">다시 시도</button>
        <button id="showConsoleBtn" title="개발자 도구 열기 지침">콘솔 열기 안내</button>
      </div>
      <p class="small muted">문제가 계속되면, 브라우저 개발자도구(F12) → Application → Service Workers에서 직접 <b>Unregister</b> 해보세요.</p>
    </div>
  </div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('statusText');
    const dotEl = document.getElementById('dot');
    const runBtn = document.getElementById('runBtn');
    const reRunBtn = document.getElementById('reRunBtn');
    const reloadBtn = document.getElementById('reloadBtn');
    const showConsoleBtn = document.getElementById('showConsoleBtn');

    function log(msg) {
      const ts = new Date().toLocaleTimeString();
      logEl.textContent += `[${ts}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    function setStatus(text, kind) {
      statusEl.textContent = text;
      dotEl.className = 'dot' + (kind ? ' ' + kind : '');
    }
    function setButtons({running=false, done=false}) {
      runBtn.disabled = running;
      reRunBtn.classList.toggle('hidden', running || !done);
      reloadBtn.classList.toggle('hidden', !done);
    }

    async function resetAll() {
      try {
        setButtons({running:true, done:false});
        setStatus('초기화 실행 중…', 'warn');
        log('초기화를 시작합니다.');

        // 1) Unregister Service Workers
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          log(`발견된 Service Worker: ${regs.length}개`);
          for (const r of regs) {
            try {
              await r.unregister();
              log(' - SW 해제 완료');
            } catch (e) {
              log(' - SW 해제 실패: ' + (e && e.message));
            }
          }
        } else {
          log('이 브라우저는 Service Worker를 지원하지 않습니다.');
        }

        // 2) Clear Cache Storage
        if (window.caches && caches.keys) {
          const keys = await caches.keys();
          log(`발견된 캐시 키: ${keys.length}개`);
          for (const k of keys) {
            try {
              await caches.delete(k);
              log(` - 캐시 삭제: ${k}`);
            } catch (e) {
              log(' - 캐시 삭제 실패: ' + (e && e.message));
            }
          }
        } else {
          log('Cache Storage API를 사용할 수 없습니다.');
        }

        // 3) Storage cleanup
        try { localStorage.clear?.(); log('localStorage 삭제 완료'); } catch(e) { log('localStorage 삭제 실패: ' + e.message); }
        try { sessionStorage.clear?.(); log('sessionStorage 삭제 완료'); } catch(e) { log('sessionStorage 삭제 실패: ' + e.message); }

        // 4) Done
        setStatus('✅ 초기화 완료! 이제 최신 파일을 불러옵니다.', 'ok');
        setButtons({running:false, done:true});

        // 5) Provide link to main page with cache-busting param
        const base = location.origin + location.pathname.replace(/index_sw_reset[_\w-]*\.html?$/i, '');
        const target = base || (location.origin + '/');
        const url = new URL(target, location.href);
        url.searchParams.set('nocache', Date.now().toString());
        reloadBtn.href = url.toString();
        log('이제 "메인으로 이동" 버튼을 클릭해 최신 페이지로 이동하세요.');
      } catch (e) {
        setStatus('오류 발생: ' + (e && e.message ? e.message : e), 'warn');
        setButtons({running:false, done:false});
        reRunBtn.classList.remove('hidden');
        log('초기화 도중 오류가 발생했습니다.');
        console.error(e);
      }
    }

    runBtn.addEventListener('click', resetAll);
    reRunBtn.addEventListener('click', resetAll);
    showConsoleBtn.addEventListener('click', () => {
      alert('크롬: F12 → Application → Service Workers → Unregister\nEdge: 크롬과 동일\nFirefox: 개발자도구 → 저장소(Storage) → Service Workers');
    });

    // Auto-run once on open
    resetAll();
  </script>
</body>
</html>
