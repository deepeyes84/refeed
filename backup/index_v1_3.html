<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>피크위크 계산기 — v1.3 (계산·시각화·타임라인·운동연동)</title>
  <meta name="description" content="v1.1 계산 + v1.2 시각화 + 스케줄/타임라인 뷰 + 운동량 연동. CDN-only." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#f8fafc}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .stat{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:12px;padding:12px}
    .btn{padding:.5rem .8rem;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.5rem;border-bottom:1px solid #e5e7eb;font-size:14px;vertical-align:top}
    .badge{display:inline-block;padding:.15rem .5rem;border-radius:.5rem;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:12px}
    input[type=number]{appearance:textfield;-moz-appearance:textfield}
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{appearance:none;margin:0}
  </style>

  <!-- React / ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- react-is + Recharts -->
  <script src="https://cdn.jsdelivr.net/npm/react-is/umd/react-is.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>

  <!-- html2canvas (PNG export) + Babel (JSX) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="env,react">
    const { useMemo, useState, useRef } = React;
    const r1 = n => Math.round((+n)*10)/10;
    const clamp = (n,a,b)=>Math.min(Math.max(n,a),b);
    const num = (s,d=0)=>{ const v=parseFloat(s); return isNaN(v)?d:v; };

    const DAY_OPTIONS=[
      { key:-8, label:"D-8 (리피딩)" },
      { key:-7, label:"D-7 (리피딩)" },
      { key:-6, label:"D-6 (디플리션)" },
      { key:-5, label:"D-5 (디플리션)" },
      { key:-4, label:"D-4 (디플리션)" },
      { key:-3, label:"D-3 (디플리션)" },
      { key:-2, label:"D-2 (슈퍼컴펜세이션)" },
      { key:-1, label:"D-1 (슈퍼컴펜세이션)" },
      { key:0,  label:"D-day (퍼포먼스)" },
    ];
    const PROFILE_OPTIONS=[
      { key:"conservative", label:"보수적" },
      { key:"standard", label:"표준" },
      { key:"aggressive", label:"공격적" },
      { key:"extreme", label:"익스트림" },
    ];
    const PROTEIN_LEVELS=[2.3,2.6,2.9,3.1];
    const PHASE_LABEL={ refeed:"리피딩", depletion:"디플리션", supercomp:"슈퍼컴펜세이션", showday:"대회 퍼포먼스" };

    function phaseForDay(d){ if(d===-8||d===-7) return "refeed"; if(d>=-6&&d<=-3) return "depletion"; if(d===-2||d===-1) return "supercomp"; return "showday"; }
    function defaultsByPhase(phase, profile="standard"){
      if(phase==="refeed"){
        return ({conservative:{kind:"perLBM",cPer:4,fatPct:0.20},
                 standard:{kind:"perLBM",cPer:6,fatPct:0.20},
                 aggressive:{kind:"perLBM",cPer:8,fatPct:0.18},
                 extreme:{kind:"perLBM",cPer:10,fatPct:0.15}})[profile];
      }
      if(phase==="depletion"){
        return ({conservative:{kind:"perLBM",cPer:1.25,fatPct:0.25},
                 standard:{kind:"perLBM",cPer:1.0,fatPct:0.25},
                 aggressive:{kind:"perLBM",cPer:0.75,fatPct:0.27},
                 extreme:{kind:"perLBM",cPer:0.5,fatPct:0.30}})[profile];
      }
      if(phase==="supercomp"){
        return ({conservative:{kind:"perLBM",cPer:5,fatPct:0.15},
                 standard:{kind:"perLBM",cPer:7,fatPct:0.15},
                 aggressive:{kind:"perLBM",cPer:9,fatPct:0.14},
                 extreme:{kind:"perLBM",cPer:10,fatPct:0.12}})[profile];
      }
      return ({conservative:{kind:"perBW",cPer:0.8,fatPct:0.15},
               standard:{kind:"perBW",cPer:1.0,fatPct:0.15},
               aggressive:{kind:"perBW",cPer:1.2,fatPct:0.15},
               extreme:{kind:"perBW",cPer:1.5,fatPct:0.12}})[profile];
    }

    function Charts({macroData,timelineData}){
      if(!window.Recharts){
        return <section className="card p-4 mt-4"><div className="text-sm text-amber-700">Recharts 로드 실패(CDN). 네트워크 확인 후 새로고침.</div></section>;
      }
      const {ResponsiveContainer,PieChart,Pie,Cell,Tooltip,BarChart,Bar,XAxis,YAxis,Legend,CartesianGrid} = window.Recharts;
      const COLORS=["#60a5fa","#34d399","#f59e0b"];
      const fmt = v => r1(v);
      return (
        <section className="card p-4 mt-4">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="rounded-2xl border bg-white p-4">
              <div className="font-semibold mb-2">매크로 도넛 (kcal)</div>
              <div style={{width:"100%",height:240}}>
                <ResponsiveContainer width="100%" height={240}>
                  <PieChart>
                    <Pie data={macroData} dataKey="value" nameKey="name" outerRadius={90}
                         label={({name,value})=>`${name}: ${r1(value)} kcal`}>
                      {macroData.map((_,i)=><Cell key={i} fill={COLORS[i%COLORS.length]} />)}
                    </Pie>
                    <Tooltip formatter={(v,n)=>[fmt(v),n]} />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>
            <div className="rounded-2xl border bg-white p-4">
              <div className="font-semibold mb-2">D-8→D-day 매크로 타임라인 (g)</div>
              <div style={{width:"100%",height:240}}>
                <ResponsiveContainer width="100%" height={240}>
                  <BarChart data={timelineData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="day" />
                    <YAxis tickFormatter={fmt} />
                    <Tooltip formatter={(v,n)=>[fmt(v),n]} />
                    <Legend />
                    <Bar dataKey="C" name="탄수(g)" fill="#60a5fa" stackId="a" />
                    <Bar dataKey="P" name="단백질(g)" fill="#34d399" stackId="a" />
                    <Bar dataKey="F" name="지방(g)" fill="#f59e0b" stackId="a" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>
        </section>
      );
    }

    function App(){
      const printableRef = useRef(null);
      // 입력
      const [weightStr,setWeightStr] = useState("69.4");
      const [bfStr,setBfStr] = useState("6.6");
      const [dayKey,setDayKey] = useState(-8);
      const [profile,setProfile] = useState("standard");
      const [proteinLevelStr,setProteinLevelStr] = useState("2.6");

      // 운동 세션
      const [sessions,setSessions] = useState([]);

      // 파생
      const weight = useMemo(()=> num(weightStr,0),[weightStr]);
      const bf = useMemo(()=> num(bfStr,0),[bfStr]);
      const LBM = useMemo(()=> r1(weight*(1-clamp(bf,0,50)/100)),[weight,bf]);
      const proteinLevel = useMemo(()=> num(proteinLevelStr,2.6),[proteinLevelStr]);
      const phase = useMemo(()=> phaseForDay(dayKey),[dayKey]);
      const dflt = useMemo(()=> defaultsByPhase(phase,profile),[phase,profile]);

      // 목표 매크로
      const protein_g = useMemo(()=> r1(LBM*proteinLevel),[LBM,proteinLevel]);
      const carb_base = useMemo(()=> r1((dflt.kind==="perLBM"?LBM:weight)*dflt.cPer),[dflt,LBM,weight]);
      const Pk = useMemo(()=> r1(protein_g*4),[protein_g]);
      const Ck = useMemo(()=> r1(carb_base*4),[carb_base]);
      const Fk = useMemo(()=> r1((dflt.fatPct/(1-dflt.fatPct))*(Pk+Ck)),[dflt,Pk,Ck]);
      const fat_g_base = useMemo(()=> r1(Fk/9),[Fk]);

      // 운동 연동 kcal → 탄수 보정
      const metFor = (type,rpe=6)=> type==="cardio" ? Math.max(4,Math.min(12,3+rpe*1.0)) : Math.max(3.5,Math.min(8,rpe*0.9));
      const kcalEstimate = (type,minutes,rpe)=> r1(minutes*weight*0.0175*metFor(type,rpe));
      const exKcal = sessions.reduce((sum,s)=>{
        const k = (s.kcalOverride && s.kcalOverride!=="") ? num(s.kcalOverride,0) : kcalEstimate(s.type||"resistance", num(s.minutes,0), num(s.rpe,6));
        return sum+k;
      },0);
      const phaseCarbPct = ({refeed:0.7,depletion:0.5,supercomp:0.8,showday:0.4})[phase]||0.6;
      const carb_add_g = r1((exKcal*phaseCarbPct)/4);
      const carb_g = r1(carb_base + carb_add_g);
      const fat_g = fat_g_base;
      const total_kcal = r1(protein_g*4 + carb_g*4 + fat_g*9);
      const exNote = `운동 ${r1(exKcal)} kcal, 단계 보정 ${Math.round(phaseCarbPct*100)}% → 탄수 +${r1(carb_add_g)} g`;

      // 차트 데이터
      const macroData=[
        {name:"탄수",value:r1(carb_g*4)},
        {name:"단백질",value:r1(protein_g*4)},
        {name:"지방",value:r1(fat_g*9)},
      ];
      const timelineData = DAY_OPTIONS.map(opt=>{
        const ph = phaseForDay(opt.key);
        const base = defaultsByPhase(ph,profile);
        const C = r1(((base.kind==="perLBM"?LBM:weight)*base.cPer));
        const P = r1(LBM*proteinLevel);
        const Pk=r1(P*4), Ck=r1(C*4), Fk=r1((base.fatPct/(1-base.fatPct))*(Pk+Ck));
        const F = r1(Fk/9);
        return { day:opt.label, C, P, F };
      });

      // 스케줄 표
      const schedule = DAY_OPTIONS.map(opt=>{
        const ph = phaseForDay(opt.key);
        const base = defaultsByPhase(ph,profile);
        const C = r1(((base.kind==="perLBM"?LBM:weight)*base.cPer));
        const P = r1(LBM*proteinLevel);
        const Pk=r1(P*4), Ck=r1(C*4), Fk=r1((base.fatPct/(1-base.fatPct))*(Pk+Ck));
        const F = r1(Fk/9); const K = r1(Pk+Ck+Fk);
        return {day:opt.label, phase:PHASE_LABEL[ph], C, P, F, K};
      });

      async function savePNG(){
        if(!window.html2canvas){ alert("html2canvas 로드 실패"); return; }
        const node = printableRef.current || document.body;
        const canvas = await window.html2canvas(node,{scale:2,backgroundColor:"#fff"});
        const url = canvas.toDataURL("image/png");
        const a=document.createElement("a"); a.href=url; a.download="peakweek_v1_3.png"; a.click();
      }

      return (
        <div ref={printableRef}>
          <div className="max-w-6xl mx-auto p-6">
            <div className="flex items-center justify-between gap-2">
              <h1 className="text-2xl md:text-3xl font-bold">피크위크 계산기 — <span className="badge">v1.3</span></h1>
              <div className="flex gap-2">
                <button className="btn" onClick={()=>window.print()}>PDF로 인쇄</button>
                <button className="btn" onClick={savePNG}>PNG로 저장</button>
              </div>
            </div>

            {/* 입력 & 현재 목표 */}
            <section className="card p-4 mt-4">
              <div className="grid grid-cols-1 md:grid-cols-5 gap-3">
                <div className="stat">
                  <div className="text-slate-500">단계</div>
                  <div className="font-semibold">{PHASE_LABEL[phase]}</div>
                  <div className="text-xs text-slate-500 mt-1">{exNote}</div>
                </div>
                <div className="stat"><div className="text-slate-500 mb-1">체중(kg)</div><input type="number" className="w-full border rounded-xl px-3 py-2" value={weightStr} onChange={e=>setWeightStr(e.target.value)} /></div>
                <div className="stat"><div className="text-slate-500 mb-1">체지방(%)</div><input type="number" className="w-full border rounded-xl px-3 py-2" value={bfStr} onChange={e=>setBfStr(e.target.value)} /></div>
                <div className="stat"><div className="text-slate-500 mb-1">일자</div><select className="w-full border rounded-xl px-3 py-2" value={dayKey} onChange={e=>setDayKey(parseInt(e.target.value))}>{DAY_OPTIONS.map(d=> <option key={d.key} value={d.key}>{d.label}</option>)}</select></div>
                <div className="stat">
                  <div className="text-slate-500 mb-1">프로파일/단백질</div>
                  <div className="flex gap-2">
                    <select className="w-full border rounded-xl px-3 py-2" value={profile} onChange={e=>setProfile(e.target.value)}>
                      {PROFILE_OPTIONS.map(p=> <option key={p.key} value={p.key}>{p.label}</option>)}
                    </select>
                    <select className="w-full border rounded-xl px-3 py-2" value={proteinLevelStr} onChange={e=>setProteinLevelStr(e.target.value)}>
                      {PROTEIN_LEVELS.map(v=> <option key={v} value={v}>{v.toFixed(1)}</option>)}
                    </select>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
                <div className="stat"><div className="text-slate-500">탄수</div><div className="font-semibold">{r1(carb_g)} g</div></div>
                <div className="stat"><div className="text-slate-500">단백질</div><div className="font-semibold">{r1(protein_g)} g</div></div>
                <div className="stat"><div className="text-slate-500">지방</div><div className="font-semibold">{r1(fat_g)} g</div></div>
                <div className="stat"><div className="text-slate-500">총 열량</div><div className="font-semibold">{r1(total_kcal)} kcal</div></div>
              </div>
            </section>

            {/* 운동 세션 */}
            <section className="card p-4 mt-4">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div className="font-semibold">운동 세션 입력</div>
                <button className="btn" onClick={()=>setSessions(s=>[...s,{type:"resistance", rpe:7, minutes:60, kcalOverride:""}])}>세션 추가</button>
              </div>
              {sessions.length===0 ? <p className="text-sm text-slate-500 mt-2">예: 웨이트 60분 RPE7, 유산소 30분 RPE6</p> : null}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                {sessions.map((s,idx)=>(
                  <div key={idx} className="stat">
                    <div className="flex items-center justify-between mb-2">
                      <div className="font-semibold">세션 #{idx+1}</div>
                      <button className="text-xs text-red-600" onClick={()=>setSessions(arr=>arr.filter((_,i)=>i!==idx))}>삭제</button>
                    </div>
                    <div className="grid grid-cols-2 gap-2">
                      <div><label className="text-xs">종류</label>
                        <select className="w-full border rounded-xl px-2 py-1" value={s.type||"resistance"} onChange={e=>setSessions(arr=>arr.map((v,i)=>i===idx?{...v,type:e.target.value}:v))}>
                          <option value="resistance">웨이트</option><option value="cardio">유산소</option>
                        </select>
                      </div>
                      <div><label className="text-xs">RPE (1~10)</label>
                        <input type="number" className="w-full border rounded-xl px-2 py-1" value={s.rpe||6} onChange={e=>setSessions(arr=>arr.map((v,i)=>i===idx?{...v,rpe:num(e.target.value,6)}:v))}/>
                      </div>
                      <div><label className="text-xs">시간 (분)</label>
                        <input type="number" className="w-full border rounded-xl px-2 py-1" value={s.minutes||0} onChange={e=>setSessions(arr=>arr.map((v,i)=>i===idx?{...v,minutes:num(e.target.value,0)}:v))}/>
                      </div>
                      <div><label className="text-xs">kcal 직접입력(선택)</label>
                        <input type="number" className="w-full border rounded-xl px-2 py-1" value={s.kcalOverride||""} onChange={e=>setSessions(arr=>arr.map((v,i)=>i===idx?{...v,kcalOverride:e.target.value}:v))}/>
                      </div>
                    </div>
                    <div className="text-xs text-slate-500 mt-2">
                      세션 kcal: {r1(s.kcalOverride && s.kcalOverride!=="" ? num(s.kcalOverride,0) : r1(num(s.minutes,0)*num(weightStr,0)*0.0175*(s.type==="cardio"?Math.max(4,Math.min(12,3 + num(s.rpe,6))):Math.max(3.5,Math.min(8,num(s.rpe,6)*0.9)))))} kcal
                    </div>
                  </div>
                ))}
              </div>
              <div className="stat mt-3">
                <div className="text-slate-500">총 운동 kcal</div>
                <div className="font-semibold">{r1(exKcal)} kcal</div>
                <div className="text-xs text-slate-500 mt-1">단계별 탄수 보정률: {Math.round(phaseCarbPct*100)}% → 탄수 +{r1(carb_add_g)} g</div>
              </div>
            </section>

            {/* 스케줄 / 타임라인 표 */}
            <section className="card p-4 mt-4">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">스케줄 / 타임라인 (D-8 → D-day)</div>
                <div><button className="btn" onClick={()=>window.print()}>이 표만 인쇄/저장</button></div>
              </div>
              <div className="overflow-x-auto">
                <table className="table">
                  <thead><tr><th>일자</th><th>단계</th><th>목표 C/P/F</th><th>kcal</th></tr></thead>
                  <tbody>
                    {schedule.map((d,i)=>(
                      <tr key={i}><td>{d.day}</td><td><span className="badge">{d.phase}</span></td><td>C {d.C} / P {d.P} / F {d.F}</td><td>{d.K}</td></tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>

            <Charts macroData={macroData} timelineData={timelineData} />
          </div>
        </div>
      );
    }
    const root=ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>