<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>피크위크 계산기 — v1.2 (Recharts CDN 자동 대체)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    body { background: #f8fafc; }
    .notice { background: #fff3cd; color: #7c6200; border: 1px solid #ffe69c; border-radius: 12px; padding: 10px 12px; font-size: 14px; }
  </style>
  <script>
    // --- Try Recharts via jsDelivr, then unpkg fallback ---
    (function loadRecharts() {
      var loaded = false;
      function inject(src) {
        var s = document.createElement('script');
        s.src = src;
        s.onload = function(){ loaded = true; window.__RECHARTS_READY__ = true; };
        s.onerror = function(){
          if (src.indexOf('cdn.jsdelivr.net') !== -1) {
            // try fallback
            inject('https://unpkg.com/recharts/umd/Recharts.min.js');
          } else {
            window.__RECHARTS_FAILED__ = true;
          }
        };
        document.head.appendChild(s);
      }
      inject('https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js');
    })();
  </script>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 / ReactDOM 18 (also from jsDelivr to avoid same host policy issues) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- Babel (in-browser JSX) -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- App Code -->
  <script type="text/babel" data-presets="env,react">
    const { useMemo, useState, useEffect, useRef } = React;

    // 안전하게 Recharts 사용: 존재할 때만 렌더
    function ChartsSection({ macroData, timelineData, sodium_mg, potassium_mg }) {
      const rechartsOk = !!window.Recharts;
      if (!rechartsOk) {
        return (
          <section className="bg-white rounded-2xl shadow p-4 mt-4 border">
            <div className="font-semibold mb-2">시각화 대시보드</div>
            <div className="notice">Recharts CDN을 불러오지 못해 차트가 숨겨졌습니다. 다른 네트워크로 접속하거나, 잠시 후 다시 시도하세요.</div>
          </section>
        );
      }
      const { ResponsiveContainer, PieChart, Pie, Cell, Tooltip, BarChart, Bar, XAxis, YAxis, Legend, CartesianGrid, LineChart, Line, RadialBarChart, RadialBar } = window.Recharts;
      const COLORS = ["#60a5fa", "#34d399", "#f59e0b"];
      const naGauge = [{ name: "Na", value: sodium_mg, fill: "#60a5fa" }];
      const kGauge  = [{ name: "K", value: potassium_mg, fill: "#34d399" }];

      return (
        <section className="bg-white rounded-2xl shadow p-4 mt-4 border">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="rounded-2xl border bg-white p-4">
              <div className="font-semibold mb-2">오늘 매크로 도넛 (kcal 기준)</div>
              <div style={{ width: "100%", height: 240 }}>
                <ResponsiveContainer width="100%" height={240}>
                  <PieChart>
                    <Pie data={macroData} dataKey="value" nameKey="name" outerRadius={90} label>
                      {macroData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                    </Pie>
                    <Tooltip />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>
            <div className="rounded-2xl border bg-white p-4">
              <div className="font-semibold mb-2">D-8→D-day 매크로 타임라인 (g)</div>
              <div style={{ width: "100%", height: 260 }}>
                <ResponsiveContainer width="100%" height={260}>
                  <BarChart data={timelineData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="day" />
                    <YAxis />
                    <Tooltip />
                    <Legend />
                    <Bar dataKey="C" name="탄수(g)" fill="#60a5fa" stackId="a" />
                    <Bar dataKey="P" name="단백질(g)" fill="#34d399" stackId="a" />
                    <Bar dataKey="F" name="지방(g)" fill="#f59e0b" stackId="a" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>
        </section>
      );
    }

    // ---- 기존 계산기 로직(간략화: 차트 의존 부분만 별도 컴포넌트로 분리) ----
    function PeakWeekCalculator_V12_Fallback() {
      // (필요 핵심만 유지 - 사용성이 중요한 요약만 포함)
      const FOODS = {
        garaetteok: { name: "가래떡", unit: 100, C: 49.0, P: 3.7, F: 0.4, kcal: 213 },
        rice: { name: "흰쌀밥(밥)", unit: 100, C: 28.3, P: 2.7, F: 0.3, kcal: 130 },
        honey: { name: "밤꿀", unit: 100, C: 82.4, P: 0.3, F: 0.0, kcal: 304 },
        chicken: { name: "닭안심살", unit: 100, C: 0.0, P: 23.1, F: 1.2, kcal: 110 },
        eggwhite: { name: "계란흰자", unit: 100, C: 0.73, P: 10.9, F: 0.17, kcal: 52 },
        wpi: { name: "WPI", unit: 30, C: 1.0, P: 25.0, F: 0.5, kcal: 110 },
        avocado: { name: "아보카도", unit: 100, C: 8.5, P: 2.0, F: 14.7, kcal: 160 },
        oliveoil: { name: "올리브오일", unit: 1, C: 0.0, P: 0.0, F: 1.0, kcal: 9 },
      };
      const DAY_OPTIONS = [
        { key: -8, label: "D-8 (리피딩)" },
        { key: -7, label: "D-7 (리피딩)" },
        { key: -6, label: "D-6 (디플리션)" },
        { key: -5, label: "D-5 (디플리션)" },
        { key: -4, label: "D-4 (디플리션)" },
        { key: -3, label: "D-3 (디플리션)" },
        { key: -2, label: "D-2 (슈퍼컴펜세이션)" },
        { key: -1, label: "D-1 (슈퍼컴펜세이션)" },
        { key: 0, label: "D-day (퍼포먼스)" },
      ];
      const PROFILE_OPTIONS = [
        { key: "conservative", label: "보수적" },
        { key: "standard", label: "표준" },
        { key: "aggressive", label: "공격적" },
        { key: "extreme", label: "익스트림" },
      ];
      const PROTEIN_LEVELS = [2.3, 2.6, 2.9, 3.1];

      function clamp(n, min, max) { return Math.min(Math.max(n, min), max); }
      function round2(n) { return Math.round(n * 100) / 100; }
      function kcalFromMacros({ P, C, F }) { return P * 4 + C * 4 + F * 9; }
      function phaseForDay(dayKey) {
        if (dayKey === -8 || dayKey === -7) return "refeed";
        if (dayKey >= -6 && dayKey <= -3) return "depletion";
        if (dayKey === -2 || dayKey === -1) return "supercomp";
        return "showday";
      }
      function labelForPhase(phase) {
        return ({ refeed: "리피딩", depletion: "디플리션", supercomp: "슈퍼컴펜세이션", showday: "대회 퍼포먼스" })[phase];
      }
      function defaultsByPhase(phase, profile) {
        const p = profile || "standard";
        if (phase === "refeed") {
          return ({
            conservative: { kind: "perLBM", cPer: 4.0, fatPct: 0.20 },
            standard:     { kind: "perLBM", cPer: 6.0, fatPct: 0.20 },
            aggressive:   { kind: "perLBM", cPer: 8.0, fatPct: 0.18 },
            extreme:      { kind: "perLBM", cPer: 10.0, fatPct: 0.15 },
          })[p];
        }
        if (phase === "depletion") {
          return ({
            conservative: { kind: "perLBM", cPer: 1.25, fatPct: 0.25 },
            standard:     { kind: "perLBM", cPer: 1.0,  fatPct: 0.25 },
            aggressive:   { kind: "perLBM", cPer: 0.75, fatPct: 0.27 },
            extreme:      { kind: "perLBM", cPer: 0.5,  fatPct: 0.30 },
          })[p];
        }
        if (phase === "supercomp") {
          return ({
            conservative: { kind: "perLBM", cPer: 5.0,  fatPct: 0.15 },
            standard:     { kind: "perLBM", cPer: 7.0,  fatPct: 0.15 },
            aggressive:   { kind: "perLBM", cPer: 9.0,  fatPct: 0.14 },
            extreme:      { kind: "perLBM", cPer: 10.0, fatPct: 0.12 },
          })[p];
        }
        return ({
          conservative: { kind: "perBW", cPer: 0.8, fatPct: 0.15 },
          standard:     { kind: "perBW", cPer: 1.0, fatPct: 0.15 },
          aggressive:   { kind: "perBW", cPer: 1.2, fatPct: 0.15 },
          extreme:      { kind: "perBW", cPer: 1.5, fatPct: 0.12 },
        })[p];
      }

      // ---- Inputs ----
      const [weight, setWeight] = useState(69.4);
      const [bf, setBf] = useState(6.6);
      const [dayKey, setDayKey] = useState(-8);
      const [profile, setProfile] = useState("standard");
      const [proteinLevel, setProteinLevel] = useState(2.6);
      const [carbMix, setCarbMix] = useState({ garaetteok: 60, rice: 30, honey: 10 });

      const LBM = useMemo(() => weight * (1 - Math.min(Math.max(bf, 0), 50) / 100), [weight, bf]);
      const phase = useMemo(() => phaseForDay(dayKey), [dayKey]);
      const dflt = useMemo(() => defaultsByPhase(phase, profile), [phase, profile]);

      const protein_g = useMemo(() => LBM * proteinLevel, [LBM, proteinLevel]);
      const carb_g    = useMemo(() => (dflt.kind === "perLBM" ? LBM : weight) * dflt.cPer, [dflt, LBM, weight]);
      const Pkcal = protein_g * 4;
      const Ckcal = carb_g * 4;
      const Fkcal = (dflt.fatPct / (1 - dflt.fatPct)) * (Pkcal + Ckcal);
      const fat_g = Fkcal / 9;
      const total_kcal = Pkcal + Ckcal + Fkcal;

      const macroData = [
        { name: "탄수", value: carb_g * 4 },
        { name: "단백질", value: protein_g * 4 },
        { name: "지방", value: fat_g * 9 },
      ];

      const timelineData = DAY_OPTIONS.map((opt) => {
        const ph = phaseForDay(opt.key);
        const base = defaultsByPhase(ph, profile);
        const C = (base.kind === "perLBM" ? LBM : weight) * base.cPer;
        const P = LBM * proteinLevel;
        const Pk = P * 4, Ck = C * 4, Fk = (base.fatPct / (1 - base.fatPct)) * (Pk + Ck);
        const F = Fk / 9;
        return { day: opt.label, C, P, F };
      });

      const sodium_mg = weight * 45; // 간단화
      const potassium_mg = Math.round(sodium_mg * 1.2);

      return (
        <div className="w-full min-h-screen bg-slate-50 text-slate-900">
          <div className="max-w-5xl mx-auto p-6">
            <h1 className="text-2xl md:text-3xl font-bold tracking-tight">피크위크 계산기 — v1.2</h1>

            <section className="bg-white rounded-2xl shadow p-4 mt-4 border">
              <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div><label className="block text-sm mb-1">체중 (kg)</label><input className="w-full border rounded-xl px-3 py-2" value={weight} onChange={e=>setWeight(parseFloat(e.target.value||0))} /></div>
                <div><label className="block text-sm mb-1">체지방률 (%)</label><input className="w-full border rounded-xl px-3 py-2" value={bf} onChange={e=>setBf(parseFloat(e.target.value||0))} /></div>
                <div>
                  <label className="block text-sm mb-1">일자</label>
                  <select className="w-full border rounded-xl px-3 py-2" value={dayKey} onChange={e=>setDayKey(parseInt(e.target.value))}>
                    {DAY_OPTIONS.map(d=> <option key={d.key} value={d.key}>{d.label}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm mb-1">프로파일</label>
                  <select className="w-full border rounded-xl px-3 py-2" value={profile} onChange={e=>setProfile(e.target.value)}>
                    {PROFILE_OPTIONS.map(p=> <option key={p.key} value={p.key}>{p.label}</option>)}
                  </select>
                </div>
              </div>
            </section>

            <section className="bg-white rounded-2xl shadow p-4 mt-4 border">
              <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">단계</div><div className="font-semibold">{labelForPhase(phase)}</div></div>
                <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">탄수</div><div className="font-semibold">{round2(carb_g)} g</div></div>
                <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">단백질</div><div className="font-semibold">{round2(protein_g)} g</div></div>
                <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">지방</div><div className="font-semibold">{round2(fat_g)} g</div></div>
                <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">총 열량</div><div className="font-semibold">{round2(total_kcal)} kcal</div></div>
              </div>
            </section>

            {/* 차트 섹션 (Recharts 성공 시에만 렌더) */}
            <ChartsSection macroData={macroData} timelineData={timelineData} sodium_mg={sodium_mg} potassium_mg={potassium_mg} />
          </div>
        </div>
      );
    }

    function mount() {
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<PeakWeekCalculator_V12_Fallback />);
    }

    // Wait for Babel & (optionally) Recharts
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', mount);
    } else {
      mount();
    }
  </script>
</body>
</html>
