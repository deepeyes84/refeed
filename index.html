<html lang="ko"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Peak Week Helper v1.4 — 체중로그·피드백 + 무대 당일 전략 + 재료 관리</title>
  <style>
    :root{
      --bg:#0f172a;        /* slate-900 */
      --panel:#111827;     /* gray-900 */
      --panel-2:#0b1220;   /* darker */
      --muted:#94a3b8;     /* slate-400 */
      --text:#e5e7eb;      /* gray-200 */
      --brand:#22d3ee;     /* cyan-400 */
      --accent:#60a5fa;    /* blue-400 */
      --ok:#34d399;        /* emerald-400 */
      --warn:#fbbf24;      /* amber-400 */
      --bad:#f87171;       /* red-400 */
      --card:#111827;
      --border:#1f2937;    /* gray-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg, var(--bg), #060b16 50%, #030712);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background:rgba(3,7,18,0.6);
      border-bottom:1px solid var(--border);
      padding:10px 14px;
      display:flex; align-items:center; gap:16px; justify-content:space-between;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight:700; letter-spacing:.2px;
    }
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--panel); color:var(--brand); font-weight:700; font-size:12px; border:1px solid var(--border)}
    .sub{color:var(--muted); font-size:12px}
    .wrap{max-width:1100px; margin:24px auto; padding:0 16px 60px}
    .grid{display:grid; gap:16px}
    @media(min-width:900px){ .grid{ grid-template-columns: 1.3fr 1fr } }
    .card{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid var(--border);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    h2{margin:0 0 8px 0; font-size:18px}
    h3{margin:12px 0 6px; font-size:15px; color:#cbd5e1}
    label{font-size:13px; color:#cbd5e1}
    input, select, button, textarea{
      background:#0b1220; color:var(--text);
      border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; font-size:14px;
    }
    input, select, textarea{width:100%}
    button{cursor:pointer}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .row3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px}
    .muted{color:var(--muted)}
    .pill{padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:rgba(255,255,255,0.03)}
    .table{width:100%; border-collapse:collapse; font-size:13px}
    .table th,.table td{border-bottom:1px dashed var(--border); padding:8px 6px; text-align:right}
    .table th{text-align:right; color:#9fb2cb; font-weight:600}
    .table th:first-child,.table td:first-child{text-align:left}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .kicker{font-size:12px; color:#a5b4fc}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{margin-left:auto}
    .small{font-size:12px}
    .hr{height:1px; background:var(--border); margin:12px 0}
    .tag{font-size:12px; color:#a3e635; border:1px solid var(--border); border-radius:999px; padding:2px 8px; background:rgba(163,230,53,.06)}
    .ghost{background:transparent}
    .qty{display:flex; gap:6px; align-items:center}
    .qty input{width:90px}
    .sticky-footer{
      position:fixed; bottom:8px; left:0; right:0; display:flex; justify-content:center; pointer-events:none;
    }
    .sticky-footer .inner{pointer-events:auto; display:flex; gap:8px; background:rgba(2,6,23,.6); border:1px solid var(--border); border-radius:999px; padding:8px; backdrop-filter:blur(12px)}
    .link{color:var(--brand); text-decoration:none; border-bottom:1px dotted var(--brand)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  </style>
</head>
<body>
  <header>
    <div class="title">
      <span>🏆 Peak Week Helper</span>
      <span class="badge">v1.4</span>
      <span class="sub">체중로그·피드백 + 무대 당일 전략 + 재료 관리</span>
    </div>
    <div class="flex">
      <span class="kicker">대회일</span>
      <input type="date" id="compDate" style="width:auto">
      <span id="dday" class="pill">D-8</span>
    </div>
  </header>

  <div class="wrap grid">
    <!-- Left column -->
    <section class="card" id="logCard">
      <div class="flex">
        <h2>📊 체중/인바디 로그 &amp; 자동 피드백</h2>
        <span class="pill right">로컬 저장됨</span>
      </div>
      <p class="muted small">※ 수치 단위: 체중(kg), 체지방률(%). 최근 3일 추세를 기준으로 “탄수 +10%”, “지방 -5g” 같은 권고 메시지가 생성됩니다.</p>

      <div class="row">
        <div>
          <label>목표 체중</label>
          <input id="targetWeight" type="number" step="0.1" placeholder="예: 68.0">
        </div>
        <div>
          <label>목표 체지방률</label>
          <input id="targetBf" type="number" step="0.1" placeholder="예: 3.0">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>오늘 날짜</label>
          <input id="logDate" type="date">
        </div>
        <div>
          <label>아침 체중(kg)</label>
          <input id="logWeight" type="number" step="0.1" placeholder="예: 69.2">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>체지방률(%)</label>
          <input id="logBf" type="number" step="0.1" placeholder="예: 4.2">
        </div>
        <div>
          <label>비고</label>
          <input id="logNote" type="text" placeholder="예: 붓기 약간, 수분 적음">
        </div>
      </div>

      <div class="actions" style="margin-top:10px">
        <button onclick="addLog()">+ 오늘 기록 추가</button>
        <button class="ghost" onclick="clearLogsConfirm()">로그 초기화</button>
        <button class="ghost" onclick="downloadData()">데이터 내보내기(JSON)</button>
        <label class="pill">
          <input id="uploadJson" type="file" accept="application/json" style="display:none" onchange="uploadData(event)">
          <a href="#" class="link" onclick="document.getElementById('uploadJson').click()">데이터 불러오기(JSON)</a>
        </label>
      </div>

      <div id="feedback" class="pill" style="margin-top:10px">로그를 추가하면 자동 피드백이 표시됩니다.</div>

      <div class="hr"></div>

      <table class="table" id="logTable">
        <thead>
          <tr>
            <th>날짜</th><th>체중</th><th>체지방률</th><th>목표대비(kg)</th><th>비고</th><th>삭제</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </section>

    <!-- Right column -->
    <section class="card" id="stageCard">
      <div class="flex">
        <h2>🎯 무대 당일 전략 빌더</h2>
        <span class="pill right" id="stageHint">D-8 기준</span>
      </div>
      <p class="muted small">전략에 따라 권장 탄수/나트륨/수분을 산출하고, 보유 재료로 펌프업 스낵을 자동 구성합니다.<br>
      ※ 수치는 일반적인 스포츠영양 권고 범위에 근거한 범용 가이드이며, 개인 반응에 맞게 조정하세요.</p>

      <div class="row">
        <div>
          <label>체중(kg)</label>
          <input id="stageWeight" type="number" step="0.1" placeholder="예: 69.0">
        </div>
        <div>
          <label>무대까지 남은 시간(분)</label>
          <input id="stageMins" type="number" step="1" placeholder="예: 60">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <div>
          <label>전략</label>
          <select id="stageMode">
            <option value="vascular">혈관 강조</option>
            <option value="fullness">Fullness 우선</option>
            <option value="balanced">밸런스</option>
          </select>
        </div>
        <div>
          <label>섬유 제한(펌프 전)</label>
          <select id="fiberCap">
            <option value="yes" selected="">낮게(권장)</option>
            <option value="no">제한 없음</option>
          </select>
        </div>
      </div>

      <div class="actions" style="margin-top:10px">
        <button onclick="calcStage()">권장치 계산</button>
        <button class="ghost" onclick="buildSnack()">펌프업 스낵 자동 구성</button>
      </div>

      <div id="stageOut" class="small" style="margin-top:8px"></div>

      <h3 style="margin-top:14px">🥨 펌프업 스낵 빌더 (보유 재료 사용)</h3>
      <p class="muted small">탄수 기준으로 구성(지방 최소화, 고GI 우선). 아래 재료는 “재료 관리”에서 편집 가능합니다.</p>
      <div class="row3" id="pumpList"><div class="card" style="padding: 12px;">
      <div class="flex" style="justify-content:space-between">
        <div><b>흰밥(지은밥)</b> <span class="muted small">(28.0g C / 100g)</span></div>
        <label class="qty small">사용 <input type="checkbox" id="pmp_0" checked=""></label>
      </div>
      <div class="small muted">메모: 고GI, 저섬유</div>
    </div><div class="card" style="padding: 12px;">
      <div class="flex" style="justify-content:space-between">
        <div><b>가래떡</b> <span class="muted small">(51.0g C / 100g)</span></div>
        <label class="qty small">사용 <input type="checkbox" id="pmp_1" checked=""></label>
      </div>
      <div class="small muted">메모: 고GI, 저섬유</div>
    </div><div class="card" style="padding: 12px;">
      <div class="flex" style="justify-content:space-between">
        <div><b>꿀</b> <span class="muted small">(82.4g C / 100g)</span></div>
        <label class="qty small">사용 <input type="checkbox" id="pmp_2" checked=""></label>
      </div>
      <div class="small muted">메모: 고GI, 액상</div>
    </div></div>
      <div class="hr"></div>
      <div id="pumpPlan" class="small"></div>
    </section>

    <!-- Ingredient manager full width -->
    <section class="card" style="grid-column:1 / -1">
      <div class="flex">
        <h2>🧺 재료 관리</h2>
        <span class="pill right">초기값은 일반치 — 실제 라벨/YAZIO로 수정하세요</span>
      </div>
      <p class="muted small">단위: 100 g 기준(P/C/F, kcal). GI/메모는 선택 항목. “펌프 전용” 체크 시 무대 당일 빌더에서 우선 사용됩니다.</p>

      <div class="row3">
        <div><label>이름</label><input id="ingName" placeholder="예: 흰밥(지은밥)"></div>
        <div><label>분류</label>
          <select id="ingType">
            <option>탄수</option><option>단백</option><option>지방</option><option>보충제</option><option>기타</option>
          </select>
        </div>
        <div><label>GI/특성(선택)</label><input id="ingGi" placeholder="예: 고GI, 저섬유"></div>
      </div>
      <div class="row3" style="margin-top:8px">
        <div><label>단백질 P (g/100g)</label><input id="ingP" type="number" step="0.1"></div>
        <div><label>탄수화물 C (g/100g)</label><input id="ingC" type="number" step="0.1"></div>
        <div><label>지방 F (g/100g)</label><input id="ingF" type="number" step="0.1"></div>
      </div>
      <div class="row3" style="margin-top:8px">
        <div><label>열량 (kcal/100g)</label><input id="ingKcal" type="number" step="1"></div>
        <div class="qty">
          <input id="ingPump" type="checkbox"><label for="ingPump">펌프 전용</label>
        </div>
        <div class="actions">
          <button onclick="addIngredient()">+ 재료 추가</button>
          <button class="ghost" onclick="resetIngredients()">초기 재료 복원</button>
        </div>
      </div>

      <div class="hr"></div>
      <table class="table" id="ingTable">
        <thead>
          <tr>
            <th>이름</th><th>분류</th><th>GI/특성</th><th>P</th><th>C</th><th>F</th><th>kcal</th><th>펌프전용</th><th>삭제</th>
          </tr>
        </thead>
        <tbody><tr>
      <td style="text-align:left">흰밥(지은밥)</td>
      <td>탄수</td>
      <td style="text-align:left">고GI, 저섬유</td>
      <td>2.4</td>
      <td>28.0</td>
      <td>0.3</td>
      <td>116</td>
      <td>✅</td>
      <td><button class="ghost" onclick="deleteIngredient(0)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">가래떡</td>
      <td>탄수</td>
      <td style="text-align:left">고GI, 저섬유</td>
      <td>4.0</td>
      <td>51.0</td>
      <td>0.4</td>
      <td>234</td>
      <td>✅</td>
      <td><button class="ghost" onclick="deleteIngredient(1)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">꿀</td>
      <td>탄수</td>
      <td style="text-align:left">고GI, 액상</td>
      <td>0.3</td>
      <td>82.4</td>
      <td>0.0</td>
      <td>304</td>
      <td>✅</td>
      <td><button class="ghost" onclick="deleteIngredient(2)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">닭안심(구운)</td>
      <td>단백</td>
      <td style="text-align:left">저지방</td>
      <td>31.0</td>
      <td>0.0</td>
      <td>3.6</td>
      <td>165</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(3)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">계란(전란)</td>
      <td>단백</td>
      <td style="text-align:left"></td>
      <td>13.0</td>
      <td>1.1</td>
      <td>11.0</td>
      <td>155</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(4)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">계란흰자</td>
      <td>단백</td>
      <td style="text-align:left">저지방</td>
      <td>11.0</td>
      <td>0.7</td>
      <td>0.2</td>
      <td>52</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(5)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">무가당 그릭요거트(무지방)</td>
      <td>단백</td>
      <td style="text-align:left">낮은 GI</td>
      <td>10.3</td>
      <td>3.6</td>
      <td>0.4</td>
      <td>59</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(6)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">홍두깨살(소, 구운)</td>
      <td>단백</td>
      <td style="text-align:left"></td>
      <td>26.0</td>
      <td>0.0</td>
      <td>10.0</td>
      <td>214</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(7)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">아보카도</td>
      <td>지방</td>
      <td style="text-align:left">섬유 보통</td>
      <td>2.0</td>
      <td>9.0</td>
      <td>15.0</td>
      <td>160</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(8)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">아몬드버터</td>
      <td>지방</td>
      <td style="text-align:left"></td>
      <td>21.0</td>
      <td>19.0</td>
      <td>55.0</td>
      <td>614</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(9)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">WPI(유청단백 분리)</td>
      <td>보충제</td>
      <td style="text-align:left">스쿱 환산 필요</td>
      <td>83.0</td>
      <td>7.0</td>
      <td>3.0</td>
      <td>366</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(10)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">카제인</td>
      <td>보충제</td>
      <td style="text-align:left">스쿱 환산 필요</td>
      <td>80.0</td>
      <td>7.0</td>
      <td>2.0</td>
      <td>360</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(11)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">EAA</td>
      <td>보충제</td>
      <td style="text-align:left">무칼로리(제조사표기 확인)</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(12)">삭제</button></td>
    </tr><tr>
      <td style="text-align:left">비트즙</td>
      <td>기타</td>
      <td style="text-align:left">질산염원·당 확인</td>
      <td>0.5</td>
      <td>8.5</td>
      <td>0.0</td>
      <td>35</td>
      <td></td>
      <td><button class="ghost" onclick="deleteIngredient(13)">삭제</button></td>
    </tr></tbody>
      </table>
    </section>

    <!-- Pump routine helper -->
    <section class="card" style="grid-column:1 / -1">
      <h2>💪 백스테이지 펌프 루틴 (권장 예시)</h2>
      <p class="muted small">RPE 6~7, 통증·경련 없이 혈류와 펌프를 유도. 각 1~2세트 15~20회, 세트간 휴식 30~45초.</p>
      <ul class="small">
        <li>밴드 체스트 프레스 / 푸시업 변형</li>
        <li>밴드 로우 / 페이스풀</li>
        <li>라터럴 레이즈(가벼운 덤벨/밴드)</li>
        <li>해머 컬 / 트라이셉스 푸시다운(밴드)</li>
        <li class="muted">※ 하체 펌프는 과도한 부종 위험이 있으면 최소화</li>
      </ul>
    </section>

    <!-- Notes -->
    <section class="card" style="grid-column:1 / -1">
      <h2>ℹ️ 사용 팁 &amp; 주의</h2>
      <ul class="small">
        <li><b>데이터는 이 브라우저의 로컬스토리지</b>에 저장됩니다. 다른 기기에서는 보이지 않습니다. “데이터 내보내기/불러오기” 기능으로 백업하세요.</li>
        <li>재료의 <b>영양성분 초기값은 일반적인 식품성분표 기반</b>입니다. 실제 제품 라벨 또는 YAZIO 값으로 반드시 수정하세요.</li>
        <li>무대 당일 수분/나트륨/탄수 권장치는 <b>범용 가이드</b>입니다. 개인 반응(붓기/위장 반응/혈관/펌프)에 따라 미세조정이 필요합니다.</li>
        <li>건강상 문제가 있거나 이뇨제 등 <b>의약품·금지약물</b>은 사용하지 마세요. 새로운 보충제는 <b>무대 직전 도입 금지</b>.</li>
      </ul>
    </section>
  </div>

  <div class="sticky-footer">
    <div class="inner">
      <button onclick="downloadSelf()">index.html 저장</button>
      <a class="pill link" href="#" onclick="scrollToTop()">맨 위로</a>
    </div>
  </div>

<script>
/* ============ Utilities ============ */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

const store = {
  get(key, fallback){
    try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback }
  },
  set(key, val){
    localStorage.setItem(key, JSON.stringify(val));
  }
};

function fmt(n, d=1){
  if(n===null || n===undefined || Number.isNaN(+n)) return "-";
  return (+n).toFixed(d);
}

function todayISO(){
  const t = new Date();
  const off = t.getTimezoneOffset();
  const local = new Date(t - off*60000);
  return local.toISOString().slice(0,10);
}

function ddayStr(d){
  const now = new Date();
  const target = new Date(d+"T00:00:00");
  const oneDay = 24*60*60*1000;
  const diff = Math.ceil((target - now)/oneDay);
  return diff>=0 ? `D-${diff}` : `D+${Math.abs(diff)}`;
}

function kcalFromPCF(p,c,f){
  if([p,c,f].some(v=>v===null||v===undefined||isNaN(v))) return null;
  return p*4 + c*4 + f*9;
}

/* ============ Defaults ============ */
const DEFAULT_COMP_DATE = "2025-09-13"; // 사용자의 스포츠모델 대회일

const DEFAULT_INGS = [
  // 초기값은 일반치 — 반드시 라벨/YAZIO로 교정
  {name:"흰밥(지은밥)", type:"탄수", gi:"고GI, 저섬유", P:2.4, C:28.0, F:0.3, kcal:116, pump:true},
  {name:"가래떡", type:"탄수", gi:"고GI, 저섬유", P:4.0, C:51.0, F:0.4, kcal:234, pump:true},
  {name:"꿀", type:"탄수", gi:"고GI, 액상", P:0.3, C:82.4, F:0.0, kcal:304, pump:true},
  {name:"닭안심(구운)", type:"단백", gi:"저지방", P:31.0, C:0, F:3.6, kcal:165, pump:false},
  {name:"계란(전란)", type:"단백", gi:"", P:13.0, C:1.1, F:11.0, kcal:155, pump:false},
  {name:"계란흰자", type:"단백", gi:"저지방", P:11.0, C:0.7, F:0.2, kcal:52, pump:false},
  {name:"무가당 그릭요거트(무지방)", type:"단백", gi:"낮은 GI", P:10.3, C:3.6, F:0.4, kcal:59, pump:false},
  {name:"홍두깨살(소, 구운)", type:"단백", gi:"", P:26.0, C:0, F:10.0, kcal:214, pump:false},
  {name:"아보카도", type:"지방", gi:"섬유 보통", P:2.0, C:9.0, F:15.0, kcal:160, pump:false},
  {name:"아몬드버터", type:"지방", gi:"", P:21.0, C:19.0, F:55.0, kcal:614, pump:false},
  {name:"WPI(유청단백 분리)", type:"보충제", gi:"스쿱 환산 필요", P:83.0, C:7.0, F:3.0, kcal:366, pump:false},
  {name:"카제인", type:"보충제", gi:"스쿱 환산 필요", P:80.0, C:7.0, F:2.0, kcal:360, pump:false},
  {name:"EAA", type:"보충제", gi:"무칼로리(제조사표기 확인)", P:0, C:0, F:0, kcal:0, pump:false},
  {name:"비트즙", type:"기타", gi:"질산염원·당 확인", P:0.5, C:8.5, F:0, kcal:35, pump:false}
];

/* ============ State ============ */
let logs = store.get("v14_weightLogs", []);
let ings = store.get("v14_ingredients", null) ?? DEFAULT_INGS.slice();
let settings = store.get("v14_settings", {
  compDate: DEFAULT_COMP_DATE,
  targetWeight:null,
  targetBf:null
});

/* ============ DOM Init ============ */
function init(){
  // competition date
  $("#compDate").value = settings.compDate || DEFAULT_COMP_DATE;
  updateDday();
  $("#compDate").addEventListener("change", ()=>{
    settings.compDate = $("#compDate").value;
    store.set("v14_settings", settings);
    updateDday();
  });

  // targets
  $("#targetWeight").value = settings.targetWeight ?? "";
  $("#targetBf").value = settings.targetBf ?? "";
  $("#targetWeight").addEventListener("input", ()=>{
    settings.targetWeight = parseFloat($("#targetWeight").value)||null;
    store.set("v14_settings", settings);
    renderLogs();
  });
  $("#targetBf").addEventListener("input", ()=>{
    settings.targetBf = parseFloat($("#targetBf").value)||null;
    store.set("v14_settings", settings);
  });

  // date default today
  $("#logDate").value = todayISO();

  renderLogs();
  renderIngredients();
  injectPumpChoices();
  updateStageHint();
}

function updateDday(){
  const d = $("#compDate").value || DEFAULT_COMP_DATE;
  $("#dday").textContent = ddayStr(d);
  updateStageHint();
}

function updateStageHint(){
  const d = $("#compDate").value || DEFAULT_COMP_DATE;
  $("#stageHint").textContent = d ? `${ddayStr(d)} 기준` : "";
}

/* ============ Logs ============ */
function addLog(){
  const date = $("#logDate").value;
  const weight = parseFloat($("#logWeight").value);
  const bf = parseFloat($("#logBf").value);
  const note = $("#logNote").value?.trim() || "";

  if(!date || isNaN(weight)){
    alert("날짜와 체중을 입력하세요.");
    return;
  }
  logs.push({date, weight, bf:isNaN(bf)?null:bf, note});
  logs.sort((a,b)=> a.date.localeCompare(b.date));
  store.set("v14_weightLogs", logs);
  $("#logWeight").value = "";
  $("#logBf").value = "";
  $("#logNote").value = "";
  renderLogs();
}

function deleteLog(idx){
  if(!confirm("해당 기록을 삭제할까요?")) return;
  logs.splice(idx,1);
  store.set("v14_weightLogs", logs);
  renderLogs();
}

function clearLogsConfirm(){
  if(!confirm("모든 로그를 초기화할까요? 되돌릴 수 없습니다.")) return;
  logs = [];
  store.set("v14_weightLogs", logs);
  renderLogs();
}

function renderLogs(){
  const tb = $("#logTable tbody");
  tb.innerHTML = "";
  const tgtW = settings.targetWeight;
  logs.forEach((L, i)=>{
    const tr = document.createElement("tr");
    const delta = (tgtW ? (L.weight - tgtW) : null);
    tr.innerHTML = `
      <td>${L.date}</td>
      <td>${fmt(L.weight,1)}</td>
      <td>${fmt(L.bf,1)}</td>
      <td>${delta===null? "-": (delta>0? "+"+fmt(delta,1): fmt(delta,1))}</td>
      <td style="max-width:240px; text-align:left">${L.note||""}</td>
      <td><button class="ghost" onclick="deleteLog(${i})">삭제</button></td>
    `;
    tb.appendChild(tr);
  });
  genFeedback();
}

function slope(vals){
  // simple linear slope per day using last three points
  if(vals.length<2) return 0;
  let x=[], y=[];
  const base = new Date(vals[0].date);
  vals.forEach(v=>{
    x.push( (new Date(v.date)-base)/(24*3600*1000) );
    y.push(v.value);
  });
  // least squares
  const n = x.length;
  const sx = x.reduce((a,b)=>a+b,0);
  const sy = y.reduce((a,b)=>a+b,0);
  const sxx = x.reduce((a,b)=>a+b*b,0);
  const sxy = x.reduce((a,b,i)=>a+b*y[i],0);
  const m = (n*sxy - sx*sy) / Math.max(1e-6, (n*sxx - sx*sx));
  return m;
}

function genFeedback(){
  const feed = $("#feedback");
  if(logs.length===0){ feed.textContent="로그를 추가하면 자동 피드백이 표시됩니다."; return; }

  // take last up to 3 logs
  const last = logs.slice(-3);
  const ws = last.map(v=>({date:v.date, value:v.weight}));
  const bs = last.filter(v=>v.bf!=null).map(v=>({date:v.date, value:v.bf}));
  const wSlope = slope(ws); // kg/day
  const bSlope = bs.length>=2 ? slope(bs) : 0; // %/day

  const tgt = settings.targetWeight;
  const dday = $("#dday").textContent||"";
  const recs = [];

  // weight delta to target
  const latest = logs[logs.length-1];
  const deltaW = (tgt!=null) ? (latest.weight - tgt) : null;

  // Heuristic rules (conservative)
  if(wSlope < -0.25){
    recs.push("체중 하락 속도 빠름 → 탄수 +10%");
  }else if(wSlope > 0.25){
    recs.push("체중 상승 중 → 탄수 -10%");
  }

  if(bSlope < -0.10){
    recs.push("체지방률 급하락 → 지방 +5~10g(소화 허용 시)");
  }else if(bSlope > 0.10){
    recs.push("체지방률 상승 추세 → 지방 -5g");
  }

  if(deltaW!=null){
    if(deltaW < -0.8) recs.push("목표보다 가벼움 → 수분/나트륨 소폭 ↑, 카브업 소량 추가");
    if(deltaW > 0.8) recs.push("목표보다 무거움 → 섬유·나트륨·수분 관리, 탄수 소폭 ↓");
  }

  if(recs.length===0) recs.push("유지: 현재 계획 지속(미세조정만)");

  feed.innerHTML = `<span class="mono">${dday}</span> · 최근 3일 추세 기준 권고 — <b>${recs.join(" · ")}</b>`;
}

/* ============ Data Export/Import ============ */
function downloadData(){
  const blob = new Blob([JSON.stringify({logs, ings, settings}, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "peak-week-v14-data.json";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
function uploadData(e){
  const file = e.target.files?.[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (ev)=>{
    try{
      const obj = JSON.parse(ev.target.result);
      if(obj.logs) logs = obj.logs;
      if(obj.ings) ings = obj.ings;
      if(obj.settings) settings = {...settings, ...obj.settings};
      store.set("v14_weightLogs", logs);
      store.set("v14_ingredients", ings);
      store.set("v14_settings", settings);
      init();
      alert("데이터를 불러왔습니다.");
    }catch(err){
      alert("JSON 형식이 올바르지 않습니다.");
    }
  };
  reader.readAsText(file);
}

/* ============ Ingredients ============ */
function renderIngredients(){
  const tb = $("#ingTable tbody");
  tb.innerHTML = "";
  ings.forEach((I, idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td style="text-align:left">${I.name}</td>
      <td>${I.type}</td>
      <td style="text-align:left">${I.gi||""}</td>
      <td>${fmt(I.P,1)}</td>
      <td>${fmt(I.C,1)}</td>
      <td>${fmt(I.F,1)}</td>
      <td>${fmt(I.kcal||kcalFromPCF(I.P,I.C,I.F),0)}</td>
      <td>${I.pump? "✅": ""}</td>
      <td><button class="ghost" onclick="deleteIngredient(${idx})">삭제</button></td>
    `;
    tb.appendChild(tr);
  });
  store.set("v14_ingredients", ings);
  injectPumpChoices();
}

function addIngredient(){
  const name = $("#ingName").value?.trim();
  const type = $("#ingType").value;
  const gi = $("#ingGi").value?.trim();
  const P = parseFloat($("#ingP").value)||0;
  const C = parseFloat($("#ingC").value)||0;
  const F = parseFloat($("#ingF").value)||0;
  let kcal = parseFloat($("#ingKcal").value);
  if(isNaN(kcal)) kcal = kcalFromPCF(P,C,F);
  const pump = $("#ingPump").checked;

  if(!name){ alert("재료 이름을 입력하세요."); return; }
  ings.push({name,type,gi,P,C,F,kcal,pump});
  $("#ingName").value = ""; $("#ingGi").value = "";
  $("#ingP").value = ""; $("#ingC").value = ""; $("#ingF").value = ""; $("#ingKcal").value = "";
  $("#ingPump").checked = false;
  renderIngredients();
}

function deleteIngredient(idx){
  ings.splice(idx,1);
  renderIngredients();
}

function resetIngredients(){
  if(!confirm("초기 재료 목록으로 복원할까요? 현재 목록은 삭제됩니다.")) return;
  ings = DEFAULT_INGS.slice();
  renderIngredients();
}

/* ============ Stage Day Calculations ============ */
function calcStage(){
  const weight = parseFloat($("#stageWeight").value);
  const mins = parseFloat($("#stageMins").value);
  const mode = $("#stageMode").value;
  if(isNaN(weight) || isNaN(mins)){ alert("체중과 시간을 입력하세요."); return; }

  // Base ranges (g/kg) — conservative evidence-informed heuristics
  let carbMin, carbMax, naMin, naMax, waterMin, waterMax;
  if(mode==="vascular"){ // vascular look favors modest carbs, modest sodium, small sips water
    carbMin = 0.30; carbMax = 0.50;
    naMin = 300; naMax = 600; // mg
    waterMin = 150; waterMax = 300; // ml
  }else if(mode==="fullness"){
    carbMin = 0.60; carbMax = 1.00;
    naMin = 600; naMax = 1000;
    waterMin = 100; waterMax = 200;
  }else{ // balanced
    carbMin = 0.45; carbMax = 0.75;
    naMin = 400; naMax = 800;
    waterMin = 120; waterMax = 240;
  }

  // Time scaling: if time <45min, use lower end; if >90min, use upper end
  let tScale = 0.5;
  if(mins>=90) tScale = 1.0;
  else if(mins>=60) tScale = 0.75;
  else tScale = 0.5;

  const carbTarget = Math.round( (carbMin*(1-tScale) + carbMax*tScale) * weight ); // g
  const naTarget = Math.round( naMin*(1-tScale) + naMax*tScale ); // mg
  const waterTarget = Math.round( waterMin*(1-tScale) + waterMax*tScale ); // ml

  $("#stageOut").innerHTML = `
    <div class="pill">권장 탄수: <b>${carbTarget} g</b> · 나트륨: <b>${naTarget} mg</b> · 수분: <b>${waterTarget} ml</b></div>
    <div class="muted" style="margin-top:6px">참고: 위장 부담을 줄이기 위해 지방/섬유는 최소화, 고GI 위주(꿀·가래떡·흰밥 등).</div>
  `;
  // store temp for builder
  window._stageTargets = {carbTarget, naTarget, waterTarget, mode};
}

function injectPumpChoices(){
  const cont = $("#pumpList");
  if(!cont) return;
  cont.innerHTML = "";
  ings.filter(x=>x.pump).forEach((I, idx)=>{
    const id = "pmp_"+idx;
    const item = document.createElement("div");
    item.className = "card";
    item.style.padding="12px";
    item.innerHTML = `
      <div class="flex" style="justify-content:space-between">
        <div><b>${I.name}</b> <span class="muted small">(${fmt(I.C,1)}g C / 100g)</span></div>
        <label class="qty small">사용 <input type="checkbox" id="${id}" checked></label>
      </div>
      <div class="small muted">메모: ${I.gi||"-"}</div>
    `;
    cont.appendChild(item);
  });
}

function buildSnack(){
  const t = window._stageTargets;
  if(!t){ alert("먼저 권장치를 계산하세요."); return; }
  const fiberCap = $("#fiberCap").value==="yes";
  const pumpItems = ings.filter(x=>x.pump && !Number.isNaN(x.C) && x.C>0);
  const chosen = [];
  // gather checked
  $$("#pumpList input[type=checkbox]").forEach((el, i)=>{
    if(el.checked) chosen.push(pumpItems[i]);
  });
  if(chosen.length===0){ alert("펌프 전용 재료를 1개 이상 선택하세요."); return; }

  // Prefer highest C density first (greedy), with low fiber hint by name/gi if fiberCap
  chosen.sort((a,b)=>{
    const af = (a.gi||"").includes("저섬유") || (a.gi||"").includes("고GI") ? 1:0;
    const bf = (b.gi||"").includes("저섬유") || (b.gi||"").includes("고GI") ? 1:0;
    const fiberBias = fiberCap ? (bf-af) : 0;
    if(fiberBias!==0) return fiberBias;
    return (b.C - a.C);
  });

  let remaining = t.carbTarget;
  const plan = [];
  chosen.forEach((I, idx)=>{
    if(remaining<=0) return;
    // allocate proportionally by C density
    const share = Math.min(remaining, Math.max(10, Math.round(remaining * (I.C / chosen.reduce((s,x)=>s+x.C,0)))));
    // grams needed = (carb grams needed) / (C per g) = share / (I.C/100)
    const grams = Math.round( (share / (I.C/100)) / 5 ) * 5; // round 5g
    const carbs = Math.round( grams * (I.C/100) );
    remaining -= carbs;
    plan.push({name:I.name, grams, carbs});
  });
  if(remaining>0){
    // top up with the densest
    const I = chosen[0];
    const grams = Math.round( (remaining / (I.C/100)) / 5 ) * 5;
    const carbs = Math.round( grams * (I.C/100) );
    remaining = 0;
    if(grams>0) plan.push({name:I.name, grams, carbs});
  }

  // sodium/water hints by mode
  let extra = "";
  if(t.mode==="vascular"){
    extra = "혈관 강조: 펌프 20~30분 전 꿀 1~2 스푼 추가 가능. 소금 한 꼬집(300~600 mg Na), 물 소량 홀짝.";
  }else if(t.mode==="fullness"){
    extra = "Fullness: 가래떡/흰밥 비율↑, 나트륨 600~1000 mg, 물은 과다섭취 금지.";
  }else{
    extra = "밸런스: 꿀/가래떡/흰밥을 1:1:1에 가깝게, 나트륨 400~800 mg.";
  }

  const rows = plan.map(p=>`<tr><td>${p.name}</td><td style="text-align:right">${p.grams} g</td><td style="text-align:right">${p.carbs} g C</td></tr>`).join("");
  const totalCarb = plan.reduce((s,p)=>s+p.carbs,0);
  $("#pumpPlan").innerHTML = `
    <div class="pill">펌프업 스낵 구성 (탄수 목표 ${t.carbTarget} g → 구성 ${totalCarb} g)</div>
    <table class="table" style="margin-top:6px">
      <thead><tr><th>재료</th><th>중량</th><th>탄수</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
    <div class="muted small" style="margin-top:6px">${extra}</div>
  `;
}

/* ============ Self Download ============ */
function downloadSelf(){
  const blob = new Blob([document.documentElement.outerHTML], {type:"text/html"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "index.html";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function scrollToTop(){ window.scrollTo({top:0, behavior:"smooth"}); }

/* ============ Kickoff ============ */
document.addEventListener("DOMContentLoaded", init);
</script>


</body></html>