<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>피크위크 계산기 — v1.2 (통합 + 카보로딩 + 전해질/수분 + 타이밍 + 끼니별 플래너 + 내보내기)</title>
  <meta name="description" content="v1.1 계산 + v1.2 시각화 + 카보로딩 프리셋 + 전해질/수분 + 식사 타이밍 분할 + 끼니별 식단 플래너 + PDF/PNG 내보내기. 모든 수치 1소수." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    body{background:#f8fafc}
    .notice{background:#fff3cd;color:#7c6200;border:1px solid #ffe69c;border-radius:12px;padding:10px 12px;font-size:14px}
    .stat{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:12px;padding:12px}
    .badge{display:inline-block;padding:.15rem .5rem;border-radius:.5rem;background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe;font-size:12px}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{padding:.6rem .5rem;border-bottom:1px solid #e5e7eb;font-size:14px}
    .table th{color:#64748b;text-align:left;background:#f8fafc}
    .ok{color:#16a34a}
    .warn{color:#ca8a04}
    .err{color:#dc2626}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    input[type=number]{appearance:textfield;-moz-appearance:textfield}
    input[type=number]::-webkit-outer-spin-button,input[type=number]::-webkit-inner-spin-button{appearance:none;margin:0}
    .muted{color:#64748b}
    .chip{border:1px solid #e5e7eb;border-radius:999px;padding:.25rem .6rem;font-size:12px;background:#fff}
    .btn{padding:.5rem .8rem;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    @media print {.no-print{display:none} body{background:#fff}}
  </style>

  <!-- React / ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <!-- react-is (for Recharts) -->
  <script src="https://cdn.jsdelivr.net/npm/react-is/umd/react-is.production.min.js" crossorigin></script>

  <!-- Recharts: local then CDN -->
  <script src="./vendor/Recharts.min.js"></script>
  <script>
    (function ensureRecharts(){
      if (window.Recharts) return;
      let tried = false;
      function inj(src){
        const s=document.createElement('script');
        s.src=src;
        s.onload=()=>window.__RECHARTS_READY__=true;
        s.onerror=()=>{
          if(!tried){ tried=true; inj('https://unpkg.com/recharts/umd/Recharts.min.js'); }
          else window.__RECHARTS_FAILED__=true;
        };
        document.head.appendChild(s);
      }
      inj('https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js');
    })();
  </script>

  <!-- html2canvas for PNG export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" crossorigin></script>

  <!-- Babel -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel" data-presets="env,react">
    const { useMemo, useState, useRef } = React;

    // ---------- 유틸 (소수점 1자리 고정) ----------
    const r1 = n => Math.round((+n)*10)/10; // ensure numeric then 1-decimal
    const clamp = (n, min, max) => Math.min(Math.max(n, min), max);
    const round5 = n => Math.round(n/5)*5;
    const num = (s, d=0) => { const v = parseFloat(s); return isNaN(v) ? d : v; };

    // ---------- 옵션 ----------
    const DAY_OPTIONS = [
      { key: -8, label: "D-8 (리피딩)" },
      { key: -7, label: "D-7 (리피딩)" },
      { key: -6, label: "D-6 (디플리션)" },
      { key: -5, label: "D-5 (디플리션)" },
      { key: -4, label: "D-4 (디플리션)" },
      { key: -3, label: "D-3 (디플리션)" },
      { key: -2, label: "D-2 (슈퍼컴펜세이션)" },
      { key: -1, label: "D-1 (슈퍼컴펜세이션)" },
      { key: 0,  label: "D-day (퍼포먼스)" },
    ];
    const PROFILE_OPTIONS = [
      { key: "conservative", label: "보수적" },
      { key: "standard",     label: "표준" },
      { key: "aggressive",   label: "공격적" },
      { key: "extreme",      label: "익스트림" },
    ];
    const PROTEIN_LEVELS = [2.3, 2.6, 2.9, 3.1];

    // 식사 타이밍 키
    const MEALS = [
      { key:"breakfast", label:"아침" },
      { key:"lunch", label:"점심" },
      { key:"pre", label:"운동 전" },
      { key:"post", label:"운동 후" },
      { key:"prebed", label:"취침 전" },
    ];

    function phaseForDay(dayKey) {
      if (dayKey === -8 || dayKey === -7) return "refeed";
      if (dayKey >= -6 && dayKey <= -3)   return "depletion";
      if (dayKey === -2 || dayKey === -1) return "supercomp";
      return "showday";
    }
    function labelForPhase(phase) {
      return ({ refeed:"리피딩", depletion:"디플리션", supercomp:"슈퍼컴펜세이션", showday:"대회 퍼포먼스" })[phase];
    }
    function defaultsByPhase(phase, profile="standard") {
      if (phase === "refeed") {
        return ({
          conservative: { kind:"perLBM", cPer:4.0,  fatPct:0.20 },
          standard:     { kind:"perLBM", cPer:6.0,  fatPct:0.20 },
          aggressive:   { kind:"perLBM", cPer:8.0,  fatPct:0.18 },
          extreme:      { kind:"perLBM", cPer:10.0, fatPct:0.15 },
        })[profile];
      }
      if (phase === "depletion") {
        return ({
          conservative: { kind:"perLBM", cPer:1.25, fatPct:0.25 },
          standard:     { kind:"perLBM", cPer:1.0,  fatPct:0.25 },
          aggressive:   { kind:"perLBM", cPer:0.75, fatPct:0.27 },
          extreme:      { kind:"perLBM", cPer:0.5,  fatPct:0.30 },
        })[profile];
      }
      if (phase === "supercomp") {
        return ({
          conservative: { kind:"perLBM", cPer:5.0,  fatPct:0.15 },
          standard:     { kind:"perLBM", cPer:7.0,  fatPct:0.15 },
          aggressive:   { kind:"perLBM", cPer:9.0,  fatPct:0.14 },
          extreme:      { kind:"perLBM", cPer:10.0, fatPct:0.12 },
        })[profile];
      }
      // showday
      return ({
        conservative: { kind:"perBW", cPer:0.8, fatPct:0.15 },
        standard:     { kind:"perBW", cPer:1.0, fatPct:0.15 },
        aggressive:   { kind:"perBW", cPer:1.2, fatPct:0.15 },
        extreme:      { kind:"perBW", cPer:1.5, fatPct:0.12 },
      })[profile];
    }

    // ---------- 식품 DB ----------
    const FOODS = {
      garaetteok: { name:"가래떡", unit:100, C:49.0, P:3.7, F:0.4, kcal:213 },
      rice:       { name:"흰쌀밥(밥)", unit:100, C:28.3, P:2.7, F:0.3, kcal:130 },
      honey:      { name:"밤꿀", unit:100, C:82.4, P:0.3, F:0.0, kcal:304 },
      chicken:    { name:"닭안심살", unit:100, C:0.0,  P:23.1, F:1.2, kcal:110 },
      eggwhite:   { name:"계란흰자", unit:100, C:0.73,P:10.9, F:0.17,kcal:52  },
      wpi:        { name:"WPI", unit:30,  C:1.0,  P:25.0,F:0.5, kcal:110 },
      avocado:    { name:"아보카도", unit:100, C:8.5, P:2.0, F:14.7, kcal:160 },
      oliveoil:   { name:"올리브오일(ml≈g)", unit:1, C:0.0, P:0.0, F:1.0, kcal:9 },
    };

    const CARB_KEYS = ["garaetteok","rice","honey"]; // 카보로딩 최적 조합(고GI)

    // ---------- 차트 ----------
    function ChartsSection({ macroData, timelineData }) {
      if (!window.Recharts) {
        return (
          <section className="card p-4 mt-4">
            <div className="font-semibold mb-2">시각화 대시보드</div>
            <div className="notice">Recharts 로드 실패: <b>./vendor/Recharts.min.js</b> 를 저장소에 추가하거나, 네트워크에서 jsDelivr/unpkg 허용 후 다시 시도하세요.</div>
          </section>
        );
      }
      const { ResponsiveContainer, PieChart, Pie, Cell, Tooltip, BarChart, Bar, XAxis, YAxis, Legend, CartesianGrid } = window.Recharts;
      const COLORS = ["#60a5fa", "#34d399", "#f59e0b"];

      // 공통 포맷터(1소수)
      const fmt = v => r1(v);
      const fmtK = v => r1(v) + " kcal";

      return (
        <section className="card p-4 mt-4">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="rounded-2xl border bg-white p-4">
              <div className="font-semibold mb-2">오늘 매크로 도넛 (kcal 기준)</div>
              <div style={{ width: "100%", height: 240 }}>
                <ResponsiveContainer width="100%" height={240}>
                  <PieChart>
                    <Pie
                      data={macroData}
                      dataKey="value"
                      nameKey="name"
                      outerRadius={90}
                      label={({name, value}) => `${name}: ${fmtK(value)}`}
                    >
                      {macroData.map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                    </Pie>
                    <Tooltip formatter={(value, name)=>[fmt(value), name]} />
                  </PieChart>
                </ResponsiveContainer>
              </div>
            </div>
            <div className="rounded-2xl border bg-white p-4">
              <div className="font-semibold mb-2">D-8→D-day 매크로 타임라인 (g)</div>
              <div style={{ width: "100%", height: 260 }}>
                <ResponsiveContainer width="100%" height={260}>
                  <BarChart data={timelineData}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="day" />
                    <YAxis tickFormatter={fmt} />
                    <Tooltip formatter={(value, name)=>[fmt(value), name]} />
                    <Legend />
                    <Bar dataKey="C" name="탄수(g)" fill="#60a5fa" stackId="a" />
                    <Bar dataKey="P" name="단백질(g)" fill="#34d399" stackId="a" />
                    <Bar dataKey="F" name="지방(g)" fill="#f59e0b" stackId="a" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </div>
          </div>
        </section>
      );
    }

    // ---------- 메인 ----------
    function App(){
      const printableRef = useRef(null);

      // 입력 (문자열로 보관: 0 지우기 문제 해결)
      const [weightStr, setWeightStr] = useState("69.4");
      const [bfStr, setBfStr] = useState("6.6");
      const [dayKey, setDayKey] = useState(-8);
      const [profile, setProfile] = useState("standard");
      const [proteinLevelStr, setProteinLevelStr] = useState("2.6");

      // 전해질/수분 (문자열 상태 유지)
      const [saltGramStr, setSaltGramStr] = useState("0");     // 소금 g (1 g ≈ 393 mg Na)
      const [sodiumExtraStr, setSodiumExtraStr] = useState("0");// 추가 Na mg (가공식품 등)
      const [potassiumStr, setPotassiumStr] = useState("0");    // K mg
      const [magnesiumStr, setMagnesiumStr] = useState("0");    // Mg mg
      const [waterMlStr, setWaterMlStr] = useState("0");        // ml

      // 끼니별 Na/물 분배(%) — 기본: 운동 전/후 가중치
      const [splitNa, setSplitNa] = useState({ breakfast:15, lunch:20, pre:20, post:30, prebed:15 });
      const [splitH2O, setSplitH2O] = useState({ breakfast:20, lunch:20, pre:25, post:25, prebed:10 });

      // 플래너(식단) - g 단위 (문자열 / 하루 합계)
      const [plan, setPlan] = useState({
        garaetteok: "200",
        rice: "300",
        honey: "20",
        chicken: "300",
        eggwhite: "200",
        wpi: "30",
        avocado: "0",
        oliveoil: "0",
      });

      // 끼니별 플래너(자동 배분 결과 저장, 문자열 g)
      const [mealPlan, setMealPlan] = useState({
        breakfast:{}, lunch:{}, pre:{}, post:{}, prebed:{}
      });

      // 카보로딩 모드
      const [carbOnly, setCarbOnly] = useState(false);
      const [mix, setMix] = useState({ garaetteok: 60, rice: 30, honey: 10 }); // %

      // 식사 타이밍(분할) 퍼센트 (각 매크로 별로 합 100)
      const [splitC, setSplitC] = useState({ breakfast:20, lunch:20, pre:20, post:20, prebed:20 });
      const [splitP, setSplitP] = useState({ breakfast:20, lunch:20, pre:20, post:20, prebed:20 });
      const [splitF, setSplitF] = useState({ breakfast:20, lunch:20, pre:20, post:20, prebed:20 });

      const weight = useMemo(()=> num(weightStr, 0), [weightStr]);
      const bf = useMemo(()=> num(bfStr, 0), [bfStr]);
      const proteinLevel = useMemo(()=> num(proteinLevelStr, 2.6), [proteinLevelStr]);

      const LBM = useMemo(()=> r1(weight * (1 - clamp(bf,0,50)/100)), [weight,bf]);
      const phase = useMemo(()=> phaseForDay(dayKey), [dayKey]);
      const dflt = useMemo(()=> defaultsByPhase(phase, profile), [phase, profile]);

      // 목표 매크로 (1소수 표기)
      const protein_g = useMemo(()=> r1(LBM * proteinLevel), [LBM, proteinLevel]);
      const carb_g    = useMemo(()=> r1((dflt.kind === "perLBM" ? LBM : weight) * dflt.cPer), [dflt, LBM, weight]);
      const Pkcal = r1(protein_g*4);
      const Ckcal = r1(carb_g*4);
      const Fkcal = r1((dflt.fatPct/(1-dflt.fatPct))*(Pkcal + Ckcal));
      const fat_g = r1(Fkcal/9);
      const total_kcal = r1(Pkcal + Ckcal + Fkcal);

      // 하루 합계(현재 플랜 → 합계 매크로)
      const totals = useMemo(()=>{
        let C=0,P=0,F=0,K=0;
        Object.keys(plan).forEach(key=>{
          const f=FOODS[key]; if(!f) return;
          const g=num(plan[key], 0);
          const x=g/f.unit;
          C+=f.C*x; P+=f.P*x; F+=f.F*x; K+=f.kcal*x;
        });
        return { C:r1(C), P:r1(P), F:r1(F), K:r1(K) };
      },[plan]);

      // 차트 데이터
      const macroData = [
        { name:"탄수", value: r1(carb_g*4) },
        { name:"단백질", value: r1(protein_g*4) },
        { name:"지방", value: r1(fat_g*9) },
      ];
      const timelineData = DAY_OPTIONS.map((opt)=>{
        const ph = phaseForDay(opt.key);
        const base = defaultsByPhase(ph, profile);
        const C = r1(((base.kind==="perLBM"?LBM:weight)*base.cPer));
        const P = r1(LBM*proteinLevel);
        const Pk=r1(P*4), Ck=r1(C*4), Fk=r1((base.fatPct/(1-base.fatPct))*(Pk+Ck));
        const F = r1(Fk/9);
        return { day: opt.label, C, P, F };
      });

      // 편차
      const diff = {
        C: r1(carb_g - totals.C),
        P: r1(protein_g - totals.P),
        F: r1(fat_g - totals.F),
        K: r1(total_kcal - totals.K),
      };

      // ---- 카보로딩 자동배분 (하루 합계) ----
      function autoDistributeCarbDay() {
        const cpg = (key)=> FOODS[key].C / FOODS[key].unit;
        const totalShare = (mix.garaetteok||0) + (mix.rice||0) + (mix.honey||0);
        const share = {
          garaetteok: (mix.garaetteok||0)/totalShare,
          rice:       (mix.rice||0)/totalShare,
          honey:      (mix.honey||0)/totalShare,
        };
        const grams = {
          garaetteok: round5((carb_g * share.garaetteok) / cpg('garaetteok')),
          rice:       round5((carb_g * share.rice) / cpg('rice')),
          honey:      round5((carb_g * share.honey) / cpg('honey')),
        };
        setPlan(p=>({
          ...p,
          garaetteok: String(grams.garaetteok),
          rice: String(grams.rice),
          honey: String(grams.honey),
          // 단백질은 WPI로 맞추는 버튼 유지
        }));
      }
      function fixProteinWithWPI() {
        const need = Math.max(0, protein_g - totals.P);
        const pPerGramWPI = FOODS.wpi.P / FOODS.wpi.unit; // 25/30=0.833.. gP per g
        const wpiGrams = round5(need / pPerGramWPI);
        setPlan(p=>({ ...p, wpi:String(wpiGrams) }));
      }

      // ---- 전해질/수분 총량 ----
      const sodiumFromSalt_mg = useMemo(()=> r1(num(saltGramStr,0) * 393), [saltGramStr]);
      const sodiumExtra_mg = useMemo(()=> r1(num(sodiumExtraStr,0)), [sodiumExtraStr]);
      const sodiumTotal_mg = useMemo(()=> r1(sodiumFromSalt_mg + sodiumExtra_mg), [sodiumFromSalt_mg, sodiumExtra_mg]);
      const potassium_mg   = useMemo(()=> r1(num(potassiumStr,0)), [potassiumStr]);
      const magnesium_mg   = useMemo(()=> r1(num(magnesiumStr,0)), [magnesiumStr]);
      const water_ml       = useMemo(()=> r1(num(waterMlStr,0)), [waterMlStr]);

      // ---- 식사 타이밍 분할 계산(매크로) ----
      const sumPerc = (obj)=> Object.values(obj).reduce((a,b)=>a+Number(b||0),0);
      function splitMacro(total, splitObj){
        const out={};
        MEALS.forEach(m=>{
          const p = Number(splitObj[m.key]||0)/100;
          out[m.key] = r1(total * p);
        });
        return out;
      }
      const perMeal = {
        C: splitMacro(carb_g, { ...splitC }),
        P: splitMacro(protein_g, { ...splitP }),
        F: splitMacro(fat_g, { ...splitF }),
      };
      const perMealKcal = MEALS.reduce((acc,m)=>{
        acc[m.key] = r1(perMeal.C[m.key]*4 + perMeal.P[m.key]*4 + perMeal.F[m.key]*9);
        return acc;
      },{});

      // ---- 끼니별 전해질/수분 분배 ----
      function splitByPercent(total, splitObj){
        const out={};
        MEALS.forEach(m=>{
          const p = Number(splitObj[m.key]||0)/100;
          out[m.key] = r1(total * p);
        });
        return out;
      }
      const perMealNa   = splitByPercent(sodiumTotal_mg, splitNa);
      const perMealH2O  = splitByPercent(water_ml, splitH2O);

      // ---- 끼니별 식단 자동 배분 ----
      // 원칙:
      // - 탄수: CARB_KEYS 비율(mix)에 따라 각 끼니의 탄수(g)를 재료 g로 환산
      // - 단백질: WPI 우선으로 맞춤 (부족분 있으면 eggwhite 보조)
      // - 지방: oliveoil 우선으로 맞춤
      function autoDistributeMeals(){
        const cpg = (key)=> FOODS[key].C / FOODS[key].unit; // gC per g
        const ppg = (key)=> FOODS[key].P / FOODS[key].unit; // gP per g
        const fpg = (key)=> FOODS[key].F / FOODS[key].unit; // gF per g

        const totalShare = (mix.garaetteok||0) + (mix.rice||0) + (mix.honey||0);
        const share = {
          garaetteok: (mix.garaetteok||0)/totalShare,
          rice:       (mix.rice||0)/totalShare,
          honey:      (mix.honey||0)/totalShare,
        };

        const next = {};
        MEALS.forEach(m=>{
          // 탄수 → 재료 g
          const Ctarget = perMeal.C[m.key];
          const grams = {
            garaetteok: round5((Ctarget * share.garaetteok) / cpg('garaetteok')),
            rice:       round5((Ctarget * share.rice) / cpg('rice')),
            honey:      round5((Ctarget * share.honey) / cpg('honey')),
          };

          // 단백질(WPI 우선)
          const Ptarget = perMeal.P[m.key];
          const wpi_g_per_P = 1 / ppg('wpi'); // ≈ 1.2 g WPI per 1 g protein
          let wpiGrams = round5(Ptarget * wpi_g_per_P);
          // 지방 최소화를 위해 WPI만 우선 사용 (필요하면 흰자 보조)
          const PfromWPI = wpiGrams * ppg('wpi');
          let Pneed = Math.max(0, Ptarget - PfromWPI);
          let eggwhiteGrams = 0;
          if (Pneed > 0){
            eggwhiteGrams = round5(Pneed / ppg('eggwhite'));
          }

          // 지방(olive oil 우선)
          const Ftarget = perMeal.F[m.key];
          let oliveOilGrams = round5(Ftarget / fpg('oliveoil'));

          next[m.key] = {
            garaetteok: String(grams.garaetteok),
            rice: String(grams.rice),
            honey: String(grams.honey),
            wpi: String(wpiGrams),
            eggwhite: String(eggwhiteGrams),
            oliveoil: String(oliveOilGrams),
            chicken: "0",
            avocado: "0",
          };
        });
        setMealPlan(next);
      }

      // 합산 함수(끼니별 플랜 → 매크로)
      function macrosFromMeal(mealObj){
        let C=0,P=0,F=0,K=0;
        Object.keys(mealObj||{}).forEach(key=>{
          const g = num(mealObj[key],0);
          const f = FOODS[key]; if(!f) return;
          const x=g/f.unit;
          C += f.C*x; P += f.P*x; F += f.F*x; K += f.kcal*x;
        });
        return {C:r1(C),P:r1(P),F:r1(F),K:r1(K)};
      }

      // PNG 저장
      async function savePNG(){
        if (!window.html2canvas) { alert("html2canvas가 로드되지 않았습니다."); return; }
        const node = printableRef.current || document.body;
        const canvas = await window.html2canvas(node, {scale:2, backgroundColor:"#ffffff"});
        const url = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = "peakweek_planner.png";
        a.click();
      }

      const visibleKeys = carbOnly ? CARB_KEYS.concat(['wpi']) : Object.keys(FOODS);
      const validC = sumPerc(splitC)===100, validP = sumPerc(splitP)===100, validF = sumPerc(splitF)===100;
      const splitClass = ok => ok ? "chip" : "chip err";

      return (
        <div className="w-full min-h-screen text-slate-900" ref={printableRef}>
          <div className="max-w-6xl mx-auto p-6">
            <div className="flex items-center justify-between gap-2">
              <h1 className="text-2xl md:text-3xl font-bold tracking-tight">피크위크 계산기 — v1.2 <span className="badge">통합 + 카보로딩 + 전해질/수분 + 타이밍 + 끼니별</span></h1>
              <div className="no-print flex items-center gap-2">
                <button className="btn" onClick={()=>window.print()}>PDF로 인쇄</button>
                <button className="btn" onClick={savePNG}>PNG로 저장</button>
              </div>
            </div>
            <div className="text-sm text-slate-500">모든 수치: 소수점 1자리</div>

            {/* 입력 카드 */}
            <section className="card p-4 mt-4">
              <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                  <label className="block text-sm mb-1">체중 (kg)</label>
                  <input type="number" step="0.1" className="w-full border rounded-xl px-3 py-2"
                    value={weightStr} onChange={e=>setWeightStr(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm mb-1">체지방률 (%)</label>
                  <input type="number" step="0.1" className="w-full border rounded-xl px-3 py-2"
                    value={bfStr} onChange={e=>setBfStr(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm mb-1">일자</label>
                  <select className="w-full border rounded-xl px-3 py-2" value={dayKey} onChange={e=>setDayKey(parseInt(e.target.value))}>
                    {DAY_OPTIONS.map(d=> <option key={d.key} value={d.key}>{d.label}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm mb-1">프로파일</label>
                  <select className="w-full border rounded-xl px-3 py-2" value={profile} onChange={e=>setProfile(e.target.value)}>
                    {PROFILE_OPTIONS.map(p=> <option key={p.key} value={p.key}>{p.label}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm mb-1">단백질 (g/kg LBM)</label>
                  <select className="w-full border rounded-xl px-3 py-2" value={proteinLevelStr} onChange={e=>setProteinLevelStr(e.target.value)}>
                    {PROTEIN_LEVELS.map(v=> <option key={v} value={v}>{v.toFixed(1)}</option>)}
                  </select>
                </div>
              </div>
            </section>

            {/* 목표 요약 */}
            <section className="card p-4 mt-4">
              <div className="grid grid-cols-2 md:grid-cols-5 gap-3 text-sm">
                <div className="stat"><div className="text-slate-500 text-sm">단계</div><div className="font-semibold">{labelForPhase(phase)}</div></div>
                <div className="stat"><div className="text-slate-500 text-sm">탄수</div><div className="font-semibold">{r1(carb_g)} g</div></div>
                <div className="stat"><div className="text-slate-500 text-sm">단백질</div><div className="font-semibold">{r1(protein_g)} g</div></div>
                <div className="stat"><div className="text-slate-500 text-sm">지방</div><div className="font-semibold">{r1(fat_g)} g</div></div>
                <div className="stat"><div className="text-slate-500 text-sm">총 열량</div><div className="font-semibold">{r1(total_kcal)} kcal</div></div>
              </div>
            </section>

            {/* 카보로딩 프리셋 카드 */}
            <section className="card p-4 mt-4">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div>
                  <div className="font-semibold">카보로딩 최적 조합 (고GI): 가래떡 · 흰쌀밥 · 꿀</div>
                  <p className="text-sm text-slate-500">비율로 탄수 목표를 자동 배분할 수 있어요. (단백질은 WPI로 저지방 보정 가능)</p>
                </div>
                <label className="inline-flex items-center gap-2 text-sm">
                  <input type="checkbox" checked={carbOnly} onChange={e=>setCarbOnly(e.target.checked)} />
                  <span>카보로딩 재료만 표 보기</span>
                </label>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3 text-sm">
                <div className="stat">
                  <div className="text-slate-500 mb-1">가래떡 비율 (%)</div>
                  <input type="number" className="w-full border rounded-xl px-3 py-2" value={mix.garaetteok}
                    onChange={e=>setMix(m=>({...m, garaetteok: num(e.target.value, 0)}))} />
                </div>
                <div className="stat">
                  <div className="text-slate-500 mb-1">흰쌀밥 비율 (%)</div>
                  <input type="number" className="w-full border rounded-xl px-3 py-2" value={mix.rice}
                    onChange={e=>setMix(m=>({...m, rice: num(e.target.value, 0)}))} />
                </div>
                <div className="stat">
                  <div className="text-slate-500 mb-1">꿀 비율 (%)</div>
                  <input type="number" className="w-full border rounded-xl px-3 py-2" value={mix.honey}
                    onChange={e=>setMix(m=>({...m, honey: num(e.target.value, 0)}))} />
                </div>
              </div>
              <div className="flex flex-wrap items-center gap-2 mt-3">
                <button className="btn" onClick={autoDistributeCarbDay}>1) (하루) 탄수 자동배분</button>
                <button className="btn" onClick={fixProteinWithWPI}>2) (하루) 단백질을 WPI로 보정</button>
                <span className="text-xs text-slate-500">자동배분은 g 단위를 5g 단위로 반올림합니다.</span>
              </div>
            </section>

            {/* 전해질/수분 카드 */}
            <section className="card p-4 mt-4">
              <div className="font-semibold mb-2">전해질 · 수분 추적</div>
              <div className="grid grid-cols-1 md:grid-cols-5 gap-3 text-sm">
                <div className="stat">
                  <div className="text-slate-500 mb-1">소금 (g)</div>
                  <input type="number" step="0.1" className="w-full border rounded-xl px-3 py-2"
                    value={saltGramStr} onChange={e=>setSaltGramStr(e.target.value)} />
                  <div className="text-xs text-slate-500 mt-1">≈ Na {r1(sodiumFromSalt_mg)} mg</div>
                </div>
                <div className="stat">
                  <div className="text-slate-500 mb-1">추가 나트륨 (mg)</div>
                  <input type="number" step="1" className="w-full border rounded-xl px-3 py-2"
                    value={sodiumExtraStr} onChange={e=>setSodiumExtraStr(e.target.value)} />
                  <div className="text-xs text-slate-500 mt-1">총 Na {r1(sodiumTotal_mg)} mg</div>
                </div>
                <div className="stat">
                  <div className="text-slate-500 mb-1">칼륨 (mg)</div>
                  <input type="number" step="1" className="w-full border rounded-xl px-3 py-2"
                    value={potassiumStr} onChange={e=>setPotassiumStr(e.target.value)} />
                </div>
                <div className="stat">
                  <div className="text-slate-500 mb-1">마그네슘 (mg)</div>
                  <input type="number" step="1" className="w-full border rounded-xl px-3 py-2"
                    value={magnesiumStr} onChange={e=>setMagnesiumStr(e.target.value)} />
                </div>
                <div className="stat">
                  <div className="text-slate-500 mb-1">물 섭취 (ml)</div>
                  <input type="number" step="50" className="w-full border rounded-xl px-3 py-2"
                    value={waterMlStr} onChange={e=>setWaterMlStr(e.target.value)} />
                </div>
              </div>

              {/* 끼니별 권장 분배 % */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
                <div className="stat">
                  <div className="font-semibold mb-2">나트륨 분배(%)</div>
                  {MEALS.map(m=>(
                    <div key={m.key} className="flex items-center justify-between mb-1">
                      <span className="muted">{m.label}</span>
                      <input type="number" className="w-24 border rounded-xl px-2 py-1"
                        value={splitNa[m.key]} onChange={e=>setSplitNa(s=>({...s,[m.key]: num(e.target.value,0)}))} />
                    </div>
                  ))}
                  <div className="text-xs text-slate-500 mt-1">합계: {sumPerc(splitNa)}% (100% 권장)</div>
                </div>
                <div className="stat">
                  <div className="font-semibold mb-2">물 분배(%)</div>
                  {MEALS.map(m=>(
                    <div key={m.key} className="flex items-center justify-between mb-1">
                      <span className="muted">{m.label}</span>
                      <input type="number" className="w-24 border rounded-xl px-2 py-1"
                        value={splitH2O[m.key]} onChange={e=>setSplitH2O(s=>({...s,[m.key]: num(e.target.value,0)}))} />
                    </div>
                  ))}
                  <div className="text-xs text-slate-500 mt-1">합계: {sumPerc(splitH2O)}% (100% 권장)</div>
                </div>
              </div>

              {/* 끼니별 Na/물 추천량 */}
              <div className="overflow-x-auto mt-3">
                <table className="table">
                  <thead>
                    <tr><th>끼니</th><th>Na (mg)</th><th>물 (ml)</th></tr>
                  </thead>
                  <tbody>
                    {MEALS.map(m=> (
                      <tr key={m.key}>
                        <td>{m.label}</td>
                        <td>{r1(perMealNa[m.key]||0)}</td>
                        <td>{r1(perMealH2O[m.key]||0)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>

            {/* 식사 타이밍 분할 (매크로) */}
            <section className="card p-4 mt-4">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div className="font-semibold">식사 타이밍 분할 (아침 / 점심 / 운동 전 / 운동 후 / 취침 전)</div>
                <div className="flex items-center gap-2">
                  <span className={sumPerc(splitC)===100 ? "chip" : "chip err"}>탄수 합계 {sumPerc(splitC)}%</span>
                  <span className={sumPerc(splitP)===100 ? "chip" : "chip err"}>단백질 합계 {sumPerc(splitP)}%</span>
                  <span className={sumPerc(splitF)===100 ? "chip" : "chip err"}>지방 합계 {sumPerc(splitF)}%</span>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
                {/* 탄수 분배 */}
                <div className="stat">
                  <div className="font-semibold mb-2">탄수(%)</div>
                  {MEALS.map(m=>(
                    <div key={m.key} className="flex items-center justify-between mb-1">
                      <span className="muted">{m.label}</span>
                      <input type="number" className="w-24 border rounded-xl px-2 py-1"
                        value={splitC[m.key]} onChange={e=>setSplitC(s=>({...s,[m.key]: num(e.target.value,0)}))} />
                    </div>
                  ))}
                </div>
                {/* 단백질 분배 */}
                <div className="stat">
                  <div className="font-semibold mb-2">단백질(%)</div>
                  {MEALS.map(m=>(
                    <div key={m.key} className="flex items-center justify-between mb-1">
                      <span className="muted">{m.label}</span>
                      <input type="number" className="w-24 border rounded-xl px-2 py-1"
                        value={splitP[m.key]} onChange={e=>setSplitP(s=>({...s,[m.key]: num(e.target.value,0)}))} />
                    </div>
                  ))}
                </div>
                {/* 지방 분배 */}
                <div className="stat">
                  <div className="font-semibold mb-2">지방(%)</div>
                  {MEALS.map(m=>(
                    <div key={m.key} className="flex items-center justify-between mb-1">
                      <span className="muted">{m.label}</span>
                      <input type="number" className="w-24 border rounded-xl px-2 py-1"
                        value={splitF[m.key]} onChange={e=>setSplitF(s=>({...s,[m.key]: num(e.target.value,0)}))} />
                    </div>
                  ))}
                </div>
              </div>

              {/* 분할 결과 */}
              <div className="overflow-x-auto mt-3">
                <table className="table">
                  <thead>
                    <tr>
                      <th>끼니</th>
                      <th>탄수(g)</th>
                      <th>단백질(g)</th>
                      <th>지방(g)</th>
                      <th>kcal</th>
                    </tr>
                  </thead>
                  <tbody>
                    {MEALS.map(m=> (
                      <tr key={m.key}>
                        <td>{m.label}</td>
                        <td>{r1(perMeal.C[m.key])}</td>
                        <td>{r1(perMeal.P[m.key])}</td>
                        <td>{r1(perMeal.F[m.key])}</td>
                        <td>{r1(perMealKcal[m.key])}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </section>

            {/* 끼니별 식단 플래너 (자동 배분) */}
            <section className="card p-4 mt-4">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <div className="font-semibold">끼니별 식단 플래너 (자동 배분 → 수동 미세조정)</div>
                <div className="no-print flex items-center gap-2">
                  <button className="btn" onClick={autoDistributeMeals}>끼니별 자동 배분 실행</button>
                </div>
              </div>
              <p className="text-sm text-slate-500 mt-1">원칙: 탄수는 카보 프리셋 비율, 단백질은 WPI 우선(부족 시 흰자), 지방은 올리브오일 우선.</p>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-3">
                {MEALS.map(m=>{
                  const mp = mealPlan[m.key] || {};
                  const mac = macrosFromMeal(mp);
                  return (
                    <div key={m.key} className="stat">
                      <div className="flex items-center justify-between mb-2">
                        <div className="font-semibold">{m.label}</div>
                        <div className="text-xs text-slate-500">합계: C {mac.C} · P {mac.P} · F {mac.F} · {mac.K} kcal</div>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        {["garaetteok","rice","honey","wpi","eggwhite","oliveoil"].map(key=>(
                          <div key={key}>
                            <label className="block text-xs mb-1">{FOODS[key].name} (g)</label>
                            <input type="number" className="w-full border rounded-xl px-2 py-1"
                              value={mp[key] ?? ""}
                              onChange={e=>setMealPlan(prev=>({ ...prev, [m.key]: { ...(prev[m.key]||{}), [key]: e.target.value } }))} />
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            </section>

            {/* 식단 플래너 (하루 합계) */}
            <section className="card p-4 mt-4">
              <div className="flex items-center justify-between mb-2">
                <div className="font-semibold">식단 플래너 (하루 합계, g 단위, 1소수)</div>
                <div className="text-sm text-slate-500">목표 매크로와의 편차가 실시간 계산됩니다.</div>
              </div>
              <div className="overflow-x-auto">
                <table className="table">
                  <thead>
                    <tr><th>식품</th><th>g</th><th>탄수(g)</th><th>단백질(g)</th><th>지방(g)</th><th>kcal</th></tr>
                  </thead>
                  <tbody>
                    { visibleKeys.map((key)=>{
                      const f=FOODS[key];
                      const g=num(plan[key],0);
                      const x=g/f.unit;
                      const C=r1(f.C*x), P=r1(f.P*x), F=r1(f.F*x), K=r1(f.kcal*x);
                      return (
                        <tr key={key}>
                          <td>{f.name}</td>
                          <td><input type="number" step="1" className="w-24 border rounded-xl px-2 py-1" value={plan[key]}
                            onChange={(e)=>setPlan(p=>({...p, [key]: e.target.value}))} /></td>
                          <td>{C}</td>
                          <td>{P}</td>
                          <td>{F}</td>
                          <td>{K}</td>
                        </tr>
                      );
                    })}
                  </tbody>
                  <tfoot>
                    <tr>
                      <th>합계</th>
                      <th></th>
                      <th>{r1(totals.C)}</th>
                      <th>{r1(totals.P)}</th>
                      <th>{r1(totals.F)}</th>
                      <th>{r1(totals.K)}</th>
                    </tr>
                  </tfoot>
                </table>
              </div>

              {/* 편차 */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4 text-sm">
                <div className="stat"><div className="text-slate-500">탄수 편차</div><div className={"font-semibold "+(Math.abs(diff.C)<5?"ok":(Math.abs(diff.C)<=15?"warn":"err"))}>{r1(diff.C)} g</div></div>
                <div className="stat"><div className="text-slate-500">단백질 편차</div><div className={"font-semibold "+(Math.abs(diff.P)<5?"ok":(Math.abs(diff.P)<=15?"warn":"err"))}>{r1(diff.P)} g</div></div>
                <div className="stat"><div className="text-slate-500">지방 편차</div><div className={"font-semibold "+(Math.abs(diff.F)<5?"ok":(Math.abs(diff.F)<=15?"warn":"err"))}>{r1(diff.F)} g</div></div>
                <div className="stat"><div className="text-slate-500">열량 편차</div><div className={"font-semibold "+(Math.abs(diff.K)<50?"ok":(Math.abs(diff.K)<=150?"warn":"err"))}>{r1(diff.K)} kcal</div></div>
              </div>
            </section>

            {/* 차트 */}
            <ChartsSection macroData={macroData} timelineData={timelineData} />
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
