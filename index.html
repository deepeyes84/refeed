<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>피크위크 계산기 — v1.2 (브라우저용)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html, body { height: 100%; }
      body { background: #f8fafc; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React 18 / ReactDOM 18 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Babel (for in-browser JSX transform) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Recharts UMD -->
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- App Code (no imports; uses React global) -->
    <script type="text/babel" data-presets="env,react">
      const { useMemo, useState, useEffect, useRef } = React;
      const { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, LineChart, Line, CartesianGrid, RadialBarChart, RadialBar, Legend } = Recharts;

      const FOODS = {
        garaetteok: { name: "가래떡", unit: 100, C: 49.0, P: 3.7, F: 0.4, kcal: 213, Na: 261, fiber: 0.3, sugar: 0 },
        rice: { name: "흰쌀밥(밥)", unit: 100, C: 28.3, P: 2.7, F: 0.3, kcal: 130, Na: 1, fiber: 0.4, sugar: 0 },
        honey: { name: "밤꿀(=꿀)", unit: 100, C: 82.4, P: 0.3, F: 0.0, kcal: 304, Na: 4, fiber: 0, sugar: 82.4 },
        chicken: { name: "닭안심살", unit: 100, C: 0.0, P: 23.1, F: 1.2, kcal: 110 },
        eggwhite: { name: "계란흰자", unit: 100, C: 0.73, P: 10.9, F: 0.17, kcal: 52 },
        wpi: { name: "WPI(웨이 아이솔레이트)", unit: 30, C: 1.0, P: 25.0, F: 0.5, kcal: 110 },
        avocado: { name: "아보카도", unit: 100, C: 8.5, P: 2.0, F: 14.7, kcal: 160 },
        oliveoil: { name: "엑스트라버진 올리브오일", unit: 1, C: 0.0, P: 0.0, F: 1.0, kcal: 9 },
      };

      const DAY_OPTIONS = [
        { key: -8, label: "D-8 (리피딩)" },
        { key: -7, label: "D-7 (리피딩)" },
        { key: -6, label: "D-6 (디플리션)" },
        { key: -5, label: "D-5 (디플리션)" },
        { key: -4, label: "D-4 (디플리션)" },
        { key: -3, label: "D-3 (디플리션)" },
        { key: -2, label: "D-2 (슈퍼컴펜세이션)" },
        { key: -1, label: "D-1 (슈퍼컴펜세이션)" },
        { key: 0, label: "D-day (퍼포먼스)" },
      ];

      const PROFILE_OPTIONS = [
        { key: "conservative", label: "보수적", hint: "체중변동/붓기 민감 시" },
        { key: "standard", label: "표준", hint: "권장 기본" },
        { key: "aggressive", label: "공격적", hint: "근질/펌프 강조" },
        { key: "extreme", label: "익스트림", hint: "개인 반응 확인 필요" },
      ];

      const PROTEIN_LEVELS = [
        { key: 2.3, label: "2.3 g/kg LBM" },
        { key: 2.6, label: "2.6 g/kg LBM" },
        { key: 2.9, label: "2.9 g/kg LBM" },
        { key: 3.1, label: "3.1 g/kg LBM" },
      ];

      const MEAL_SPLITS = [
        { key: "equal", label: "균등(25/25/25/25)", values: [0.25, 0.25, 0.25, 0.25] },
        { key: "front", label: "전반부 집중(40/30/20/10)", values: [0.4, 0.3, 0.2, 0.1] },
        { key: "back", label: "후반부 집중(10/20/30/40)", values: [0.1, 0.2, 0.3, 0.4] },
        { key: "peri", label: "운동전후 집중(20/40/30/10)", values: [0.2, 0.4, 0.3, 0.1] },
      ];

      const P_SOURCES = [
        { key: "chicken", label: FOODS.chicken.name },
        { key: "eggwhite", label: FOODS.eggwhite.name },
        { key: "wpi", label: FOODS.wpi.name },
      ];

      const F_SOURCES = [
        { key: "oliveoil", label: FOODS.oliveoil.name },
        { key: "avocado", label: FOODS.avocado.name },
      ];

      function clamp(n, min, max) { return Math.min(Math.max(n, min), max); }
      function round2(n) { return Math.round(n * 100) / 100; }
      function kcalFromMacros({ P, C, F }) { return P * 4 + C * 4 + F * 9; }

      function phaseForDay(dayKey) {
        if (dayKey === -8 || dayKey === -7) return "refeed";
        if (dayKey >= -6 && dayKey <= -3) return "depletion";
        if (dayKey === -2 || dayKey === -1) return "supercomp";
        return "showday";
      }
      function labelForPhase(phase) {
        return ({ refeed: "리피딩", depletion: "디플리션", supercomp: "슈퍼컴펜세이션", showday: "대회 퍼포먼스" })[phase];
      }
      function defaultsByPhase(phase, profile = "standard") {
        if (phase === "refeed") {
          return ({
            conservative: { carbKind: "perLBM", carb_g_per: 4.0, fat_pct: 0.20 },
            standard:     { carbKind: "perLBM", carb_g_per: 6.0, fat_pct: 0.20 },
            aggressive:   { carbKind: "perLBM", carb_g_per: 8.0, fat_pct: 0.18 },
            extreme:      { carbKind: "perLBM", carb_g_per: 10.0, fat_pct: 0.15 },
          })[profile];
        }
        if (phase === "depletion") {
          return ({
            conservative: { carbKind: "perLBM", carb_g_per: 1.25, fat_pct: 0.25 },
            standard:     { carbKind: "perLBM", carb_g_per: 1.0,  fat_pct: 0.25 },
            aggressive:   { carbKind: "perLBM", carb_g_per: 0.75, fat_pct: 0.27 },
            extreme:      { carbKind: "perLBM", carb_g_per: 0.5,  fat_pct: 0.30 },
          })[profile];
        }
        if (phase === "supercomp") {
          return ({
            conservative: { carbKind: "perLBM", carb_g_per: 5.0,  fat_pct: 0.15 },
            standard:     { carbKind: "perLBM", carb_g_per: 7.0,  fat_pct: 0.15 },
            aggressive:   { carbKind: "perLBM", carb_g_per: 9.0,  fat_pct: 0.14 },
            extreme:      { carbKind: "perLBM", carb_g_per: 10.0, fat_pct: 0.12 },
          })[profile];
        }
        return ({
          conservative: { carbKind: "perBW", carb_g_per: 0.8, fat_pct: 0.15 },
          standard:     { carbKind: "perBW", carb_g_per: 1.0, fat_pct: 0.15 },
          aggressive:   { carbKind: "perBW", carb_g_per: 1.2, fat_pct: 0.15 },
          extreme:      { carbKind: "perBW", carb_g_per: 1.5, fat_pct: 0.12 },
        })[profile];
      }

      function useNumericString(initial) {
        const [str, setStr] = useState(String(initial));
        const value = useMemo(() => {
          if (str === "" || str === "." || str === "-") return 0;
          const n = Number(str);
          return Number.isFinite(n) ? n : 0;
        }, [str]);
        const onChange = (e) => {
          let s = e.target.value.replace(',', '.');
          s = s.replace(/^0+(?=\\d)/, "");
          if (/^-?\\d*(?:\\.\\d*)?$/.test(s)) setStr(s);
        };
        const onBlur = () => setStr(String(value));
        const setValue = (n) => setStr(String(n));
        return { str, value, onChange, onBlur, setValue };
      }

      function NumericField({ label, state, step = "0.1", suffix = "", min, max }) {
        return (
          <div>
            <label className="block text-sm mb-1">{label}</label>
            <input
              inputMode="decimal"
              className="w-full border rounded-xl px-3 py-2"
              value={state.str}
              onChange={state.onChange}
              onBlur={state.onBlur}
              step={step}
              {...(min!==undefined?{min}:{})}
              {...(max!==undefined?{max}:{})}
            />
            {suffix && <div className="text-xs text-slate-500 mt-1">{suffix}</div>}
          </div>
        );
      }

      function PeakWeekCalculator_V12() {
        const weightState = useNumericString(69.4);
        const bfState = useNumericString(6.6);
        const [dayKey, setDayKey] = useState(-8);
        const [profile, setProfile] = useState("standard");
        const [proteinLevel, setProteinLevel] = useState(2.6);
        const [carbMix, setCarbMix] = useState({ garaetteok: 60, rice: 30, honey: 10 });
        const [mealSplitKey, setMealSplitKey] = useState("peri");
        const [pSource, setPSource] = useState("chicken");
        const [fSource, setFSource] = useState("oliveoil");
        const customCarbState = useNumericString(0);
        const customFatPctState = useNumericString(0);

        const [yazioMode, setYazioMode] = useState(false);
        const tolC = useNumericString(0.5);
        const tolP = useNumericString(0.5);
        const tolF = useNumericString(0.5);
        const tolKcal = useNumericString(5);

        const morningWeightState = useNumericString(69.4);
        const [bloat, setBloat] = useState(0);
        const [gi, setGi] = useState(0);
        const [pump, setPump] = useState(0);
        const [applyFeedback, setApplyFeedback] = useState(false);

        const [sessions, setSessions] = useState([
          { id: "AM", type: "하체", minutes: 60, RPE: 7 },
          { id: "PM", type: "상체", minutes: 60, RPE: 7 },
        ]);

        const fiberTarget = useNumericString(15);
        const [giWeights, setGiWeights] = useState({ garaetteok: 0.2, rice: 0.15, honey: 0.5 });
        const [giAutoTune, setGiAutoTune] = useState(false);

        const [suppPlan, setSuppPlan] = useState([
          { name: "마그네슘", timing: "취침 30분 전", note: "수면/경련 예방", enable: true },
          { name: "글리신", timing: "취침 30분 전", note: "수면 보조", enable: true },
          { name: "카제인", timing: "취침 직전", note: "야간 단백질", enable: false },
          { name: "글루타민", timing: "기상 직후/운동 후", note: "소화/회복 보조", enable: true },
          { name: "오메가3", timing: "아침 식후", note: "지방산 보충", enable: true },
          { name: "KSM-66", timing: "아침", note: "스트레스 완화", enable: false },
          { name: "베타알라닌", timing: "운동 30분 전", note: "지구력 보조", enable: false },
          { name: "크레아틴", timing: "운동 후", note: "로딩 유지(개별 전략)", enable: false },
        ]);

        const minWater_ml_per_kg = useNumericString(35);

        const [rulesByDay, setRulesByDay] = useState(() => ({
          refeed: { water_ml_per_kg: 45, sodium_mg_per_kg: 50 },
          depletion: { water_ml_per_kg: 45, sodium_mg_per_kg: 50 },
          supercomp: { water_ml_per_kg: 35, sodium_mg_per_kg: 45 },
          showday: { water_ml_per_kg: 25, sodium_mg_per_kg: 35 },
        }));

        const [snapshots, setSnapshots] = useState(() => {
          const raw = localStorage.getItem("ppk_v12_snapshots");
          return raw ? JSON.parse(raw) : [];
        });

        const weight = weightState.value;
        const bf = bfState.value;
        const LBM = useMemo(() => weight * (1 - Math.min(Math.max(bf,0),50) / 100), [weight, bf]);
        const phase = useMemo(() => (dayKey), [dayKey]) && (function(){return (function(d){if(d===-8||d===-7)return"refeed";if(d>=-6&&d<=-3)return"depletion";if(d===-2||d===-1)return"supercomp";return"showday";})(dayKey)})();

        const defaults = useMemo(() => defaultsByPhase(phase, profile), [phase, profile]);

        const workoutAdjCarb = useMemo(() => {
          const total = sessions.reduce((sum, s) => {
            const perHour = {6:0,7:0.3,8:0.6,9:0.9}[s.RPE] || 0.3;
            return sum + (s.minutes/60) * perHour * LBM;
          }, 0);
          return total;
        }, [sessions, LBM]);

        const base_carb_g = useMemo(() => {
          const gPer = customCarbState.value > 0 ? customCarbState.value : defaults.carb_g_per;
          return defaults.carbKind === "perLBM" ? LBM * gPer : weight * gPer;
        }, [defaults, weight, LBM, customCarbState.value]);

        const carb_g_target_raw = base_carb_g + workoutAdjCarb;

        const feedback = useMemo(() => {
          const recs = [];
          const deltaW = morningWeightState.value - weight;
          let carbAdjPct = 0;
          let naAdjPct = 0;
          if (bloat >= 3 || gi >= 3) { carbAdjPct -= 0.1; naAdjPct -= 0.05; recs.push("복부팽만/소화불편: 탄수 -10%, Na -5% 권고"); }
          if (pump <= 1) { carbAdjPct += 0.05; recs.push("펌프감 저하: 탄수 +5% 권고"); }
          if (Math.abs(deltaW) / Math.max(1, weight) > 0.015) {
            if (deltaW > 0) recs.push("체중 급증(오버스필 가능): 다음 날 탄수 -10% 권고");
            else recs.push("체중 급감: 다음 날 탄수 +5% 권고");
          }
          return { recs, carbAdjPct, naAdjPct };
        }, [bloat, gi, pump, morningWeightState.value, weight]);

        const carb_g_target = useMemo(() => applyFeedback ? carb_g_target_raw * (1 + feedback.carbAdjPct) : carb_g_target_raw, [applyFeedback, carb_g_target_raw, feedback.carbAdjPct]);

        useEffect(() => {}, []);

        const protein_g_target = useMemo(() => LBM * proteinLevel, [LBM, proteinLevel]);
        const fat_pct = useMemo(() => (customFatPctState.value > 0 ? customFatPctState.value : defaults.fat_pct), [defaults, customFatPctState.value]);

        const Pkcal = protein_g_target * 4;
        const Ckcal = carb_g_target * 4;
        const Fkcal = (fat_pct / (1 - fat_pct)) * (Pkcal + Ckcal);
        const fat_g_target = Fkcal / 9;
        const total_kcal_target = Pkcal + Ckcal + Fkcal;

        const phaseRule = rulesByDay[phase];
        const water_ml = phaseRule.water_ml_per_kg * weight;
        const water_guard = water_ml < minWater_ml_per_kg.value * weight;
        const sodium_mg = phaseRule.sodium_mg_per_kg * weight;
        const potassium_mg = Math.round(sodium_mg * 1.2);

        function gramsForCarbFood(foodKey, carbTarget) {
          const food = FOODS[foodKey];
          const carb_per_g = food.C / food.unit;
          if (carb_per_g <= 0) return 0;
          return carbTarget / carb_per_g;
        }

        const mixSum = carbMix.garaetteok + carbMix.rice + carbMix.honey;
        const norm = mixSum === 0 ? { garaetteok: 100, rice: 0, honey: 0 } : {
          garaetteok: (carbMix.garaetteok / mixSum) * 100,
          rice: (carbMix.rice / mixSum) * 100,
          honey: (carbMix.honey / mixSum) * 100,
        };

        const carbShare = {
          garaetteok: carb_g_target * (norm.garaetteok / 100),
          rice: carb_g_target * (norm.rice / 100),
          honey: carb_g_target * (norm.honey / 100),
        };

        const gramsCarbFoods = {
          garaetteok: gramsForCarbFood("garaetteok", carbShare.garaetteok),
          rice: gramsForCarbFood("rice", carbShare.rice),
          honey: gramsForCarbFood("honey", carbShare.honey),
        };

        const PF_from_carbfoods = Object.entries(gramsCarbFoods).reduce((acc, [k, g]) => {
          const f = FOODS[k];
          acc.P += (f.P / f.unit) * g;
          acc.F += (f.F / f.unit) * g;
          acc.kcal += (f.kcal / f.unit) * g;
          return acc;
        }, { P: 0, F: 0, kcal: 0 });

        const remP = Math.max(0, protein_g_target - PF_from_carbfoods.P);
        const remF = Math.max(0, fat_g_target - PF_from_carbfoods.F);

        const pFood = FOODS[pSource];
        const fFood = FOODS[fSource];
        const gramsPfood = pFood.P > 0 ? remP / (pFood.P / pFood.unit) : 0;
        const gramsFfood = fFood.F > 0 ? remF / (fFood.F / fFood.unit) : 0;

        const kcalFromFoods =
          (FOODS.garaetteok.kcal / FOODS.garaetteok.unit) * gramsCarbFoods.garaetteok +
          (FOODS.rice.kcal / FOODS.rice.unit) * gramsCarbFoods.rice +
          (FOODS.honey.kcal / FOODS.honey.unit) * gramsCarbFoods.honey +
          (pFood.kcal / pFood.unit) * gramsPfood +
          (fFood.kcal / fFood.unit) * gramsFfood;
        const kcalDiffAuto = (Pkcal + Ckcal + Fkcal) - kcalFromFoods;
        const gramsFfoodAdj = Math.max(0, gramsFfood + (kcalDiffAuto / (fFood.kcal / fFood.unit)));

        const finalTotals = {
          P: PF_from_carbfoods.P + (pFood.P / pFood.unit) * gramsPfood,
          C: carb_g_target,
          F: PF_from_carbfoods.F + (fFood.F / fFood.unit) * gramsFfoodAdj,
        };
        const finalKcal = kcalFromMacros(finalTotals);

        const split = (function(){
          const MEAL_SPLITS_MAP = { peri: [0.2,0.4,0.3,0.1], equal: [0.25,0.25,0.25,0.25], front:[0.4,0.3,0.2,0.1], back:[0.1,0.2,0.3,0.4] };
          return sessions.some(s => s.minutes > 0) ? MEAL_SPLITS_MAP["peri"] : MEAL_SPLITS_MAP[mealSplitKey] || MEAL_SPLITS_MAP["equal"];
        })();
        const mealNames = ["아침", "점심(운동전)", "저녁(운동후)", "간식/무대 전"];

        const meals = mealNames.map((name, i) => {
          const r = split[i];
          const g_garae = gramsCarbFoods.garaetteok * r;
          const g_rice = gramsCarbFoods.rice * r;
          const g_honey = gramsCarbFoods.honey * r;
          const g_p = gramsPfood * r;
          const g_f = gramsFfoodAdj * r;

          const kcal =
            (FOODS.garaetteok.kcal / FOODS.garaetteok.unit) * g_garae +
            (FOODS.rice.kcal / FOODS.rice.unit) * g_rice +
            (FOODS.honey.kcal / FOODS.honey.unit) * g_honey +
            (pFood.kcal / pFood.unit) * g_p +
            (fFood.kcal / fFood.unit) * g_f;

          const Na = sodium_mg * r;
          const K = potassium_mg * r;

          return { name, grams: { garaetteok: g_garae, rice: g_rice, honey: g_honey, pFood: g_p, fFood: g_f }, kcal, Na, K };
        });

        const [stageTime, setStageTime] = useState("14:00");
        const quickCarbPlan = useMemo(() => {
          const totalQuick = weight * 0.3;
          const times = [90, 45, 15];
          const shares = [0.5, 0.3, 0.2];
          const items = times.map((t, idx) => {
            const gCarb = totalQuick * shares[idx];
            const honeyCarb = gCarb * 0.7;
            const garaeCarb = gCarb * 0.3;
            const honey_g = gramsForCarbFood("honey", honeyCarb);
            const garae_g = gramsForCarbFood("garaetteok", garaeCarb);
            return { tmin: t, honey_g, garae_g, carb: gCarb };
          });
          return { totalQuick, items };
        }, [weight]);

        const checks = [];
        const kcalDiffPct = (finalKcal - total_kcal_target) / Math.max(1, total_kcal_target);
        if (Math.abs(kcalDiffPct) > 0.02) checks.push({ level: "warn", msg: "최종 kcal이 이론값과 2% 이상 차이. 식품/라운딩 확인." });
        if (water_guard) checks.push({ level: "warn", msg: `물 섭취가 최저 가드레일(${minWater_ml_per_kg.value} mL/kg) 미만입니다.` });

        function buildYazioText() {
          const lines = [];
          meals.forEach((m)=>{
            lines.push(`${m.name}: 가래떡 ${round2(m.grams.garaetteok)}g, 흰밥 ${round2(m.grams.rice)}g, 밤꿀 ${round2(m.grams.honey)}g, ${FOODS[pSource].name} ${round2(m.grams.pFood)}g, ${FOODS[fSource].name} ${round2(m.grams.fFood)}g — ${round2(m.kcal)}kcal`);
          });
          lines.push(`합계: P ${round2(finalTotals.P)}g, C ${round2(finalTotals.C)}g, F ${round2(finalTotals.F)}g, ${round2(finalKcal)}kcal`);
          return lines.join("\n");
        }
        function download(filename, text) {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(new Blob([text], {type: 'text/plain'}));
          a.download = filename;
          a.click();
        }
        function exportCSV() {
          const header = ["meal","garaetteok_g","rice_g","honey_g","protein_g","fat_g","kcal","Na_mg","K_mg"].join(",");
          const rows = meals.map(m=> [m.name, m.grams.garaetteok, m.grams.rice, m.grams.honey, m.grams.pFood, m.grams.fFood, m.kcal, m.Na, m.K].join(","));
          download("peakweek_v12.csv", [header, ...rows].join("\n"));
        }
        function exportJSON() {
          const obj = { inputs: { weight, bf, dayKey, profile, proteinLevel, carbMix, mealSplitKey, pSource, fSource }, totals: finalTotals, kcal: finalKcal, meals, rulesByDay };
          download("peakweek_v12.json", JSON.stringify(obj, null, 2));
        }
        function saveSnapshot() {
          const snap = { ts: new Date().toISOString(), inputs: { weight, bf, dayKey, profile, proteinLevel, carbMix, mealSplitKey, pSource, fSource }, totals: finalTotals };
          const next = [snap, ...snapshots].slice(0, 20);
          setSnapshots(next);
          localStorage.setItem("ppk_v12_snapshots", JSON.stringify(next));
        }

        const macroData = [
          { name: "탄수", value: finalTotals.C * 4 },
          { name: "단백질", value: finalTotals.P * 4 },
          { name: "지방", value: finalTotals.F * 9 },
        ];
        const COLORS = ["#60a5fa", "#34d399", "#f59e0b"];

        const timelineData = DAY_OPTIONS.map((opt)=>{
          const ph = phaseForDay(opt.key);
          const dflt = defaultsByPhase(ph, profile);
          const gPer = dflt.carb_g_per;
          const cKind = dflt.carbKind;
          const C = (cKind === "perLBM" ? LBM : weight) * gPer;
          const P = LBM * proteinLevel;
          const Pk = P * 4, Ck = C * 4, Fk = (dflt.fat_pct / (1 - dflt.fat_pct)) * (Pk + Ck);
          const F = Fk / 9;
          return { day: opt.label, C, P, F, kcal: Pk + Ck + Fk };
        });

        const glycogenWaterSeries = timelineData.map(d=> ({ day: d.day, gw: d.C * 0.003 }));

        const naGauge = [{ name: "Na", value: sodium_mg, fill: "#60a5fa" }];
        const kGauge  = [{ name: "K", value: potassium_mg, fill: "#34d399" }];

        const [order, setOrder] = useState([
          "inputs", "mix", "sources", "split_stage", "summary", "meals", "quickcarb", "diagnostics", "week", "viz", "options", "export",
        ]);
        const dragId = useRef(null);
        function onDragStart(id) { dragId.current = id; }
        function onDragOver(e) { e.preventDefault(); }
        function onDrop(id) {
          const from = order.indexOf(dragId.current);
          const to = order.indexOf(id);
          if (from===-1 || to===-1) return;
          const next = [...order];
          const [moved] = next.splice(from,1);
          next.splice(to,0,moved);
          setOrder(next);
        }

        const Section = ({ id, title, children }) => (
          <section
            draggable
            onDragStart={()=>onDragStart(id)}
            onDragOver={onDragOver}
            onDrop={()=>onDrop(id)}
            className="bg-white rounded-2xl shadow p-4 mt-4 border"
          >
            <div className="flex items-center justify-between">
              <h2 className="font-semibold mb-2">{title}</h2>
              <span className="text-xs text-slate-400 select-none">⇅ 드래그로 순서 변경</span>
            </div>
            {children}
          </section>
        );

        return (
          <div className="w-full min-h-screen bg-slate-50 text-slate-900">
            <div className="max-w-7xl mx-auto p-6">
              <h1 className="text-2xl md:text-3xl font-bold tracking-tight">피크위크 계산기 — v1.2 (옵션·시각화·드래그 정렬 추가)</h1>
              <p className="text-xs text-slate-500 mt-1">이 버전은 브라우저에서 바로 동작하도록 CDN 기반으로 구성했습니다.</p>

              {order.map((id)=>{
                if (id === "inputs") return (
                  <Section key={id} id={id} title="신체 입력 / 일·프로파일 / 커스텀">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <NumericField label="체중 (kg)" state={weightState} step="0.1" />
                        <div className="h-3" />
                        <NumericField label="체지방률 (%)" state={bfState} step="0.1" />
                        <div className="text-xs text-slate-500 mt-2">추정 LBM: <b>{round2(LBM)} kg</b></div>
                      </div>
                      <div>
                        <label className="block text-sm mb-1">대회 기준 일자</label>
                        <select value={dayKey} onChange={(e)=>setDayKey(parseInt(e.target.value))} className="w-full border rounded-xl px-3 py-2">
                          {DAY_OPTIONS.map(d=> <option key={d.key} value={d.key}>{d.label}</option>)}
                        </select>
                        <label className="block text-sm mt-3 mb-1">전략 강도(프로파일)</label>
                        <select value={profile} onChange={(e)=>setProfile(e.target.value)} className="w-full border rounded-xl px-3 py-2">
                          {PROFILE_OPTIONS.map(p=> <option key={p.key} value={p.key}>{p.label} — {p.hint}</option>)}
                        </select>
                        <label className="block text-sm mt-3 mb-1">단백질 수준</label>
                        <select value={proteinLevel} onChange={(e)=>setProteinLevel(parseFloat(e.target.value))} className="w-full border rounded-xl px-3 py-2">
                          {PROTEIN_LEVELS.map(p=> <option key={p.key} value={p.key}>{p.label}</option>)}
                        </select>
                      </div>
                      <div>
                        <NumericField label="커스텀 탄수 (g/kg) — 0이면 기본" state={customCarbState} step="0.1" />
                        <div className="h-3" />
                        <NumericField label="커스텀 지방 비율 (예: 0.2 = 20%) — 0이면 기본" state={customFatPctState} step="0.01" />
                        <div className="text-xs text-slate-500 mt-2">단계: <b>{labelForPhase(phase)}</b></div>
                      </div>
                    </div>
                  </Section>
                );

                if (id === "mix") return (
                  <Section key={id} id={id} title="탄수 혼합비 / GI 프리셋 / GI 부담 관리">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        {["garaetteok","rice","honey"].map((k)=> (
                          <div key={k} className="flex items-center gap-2 mb-2">
                            <label className="w-28 text-sm">{FOODS[k].name}</label>
                            <input
                              inputMode="numeric"
                              className="border rounded-xl px-3 py-1 w-28"
                              value={String(carbMix[k])}
                              onChange={(e)=>{
                                const raw = e.target.value.replace(/[^0-9]/g, "");
                                const clean = raw.replace(/^0+(?=\\d)/, "");
                                const n = clamp(parseInt(clean || "0"), 0, 100);
                                setCarbMix({ ...carbMix, [k]: n });
                              }}
                            />
                            <span className="text-xs text-slate-500">%</span>
                          </div>
                        ))}
                        <div className="text-xs text-slate-500">합계 {round2(carbMix.garaetteok+carbMix.rice+carbMix.honey)}% (자동 정규화)</div>

                        <div className="mt-3 p-2 rounded-xl bg-slate-50">
                          <div className="text-sm font-semibold mb-2">GI 전략 프리셋</div>
                          <div className="flex items-center gap-2">
                            <select className="border rounded-xl px-3 py-2" id="giPreset">
                              <option value="low">낮음(위장 부담 최소화)</option>
                              <option value="neutral">기본</option>
                              <option value="high">높음(빠른 충전)</option>
                            </select>
                            <button className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" onClick={()=>{
                              const el = document.getElementById('giPreset');
                              const val = el.value;
                              if (val === 'low') setCarbMix({ garaetteok: 35, rice: 55, honey: 10 });
                              else if (val === 'high') setCarbMix({ garaetteok: 55, rice: 25, honey: 20 });
                              else setCarbMix({ garaetteok: 60, rice: 30, honey: 10 });
                            }}>적용</button>
                          </div>
                        </div>
                      </div>

                      <div className="p-3 rounded-xl bg-slate-50">
                        <div className="text-sm font-semibold mb-2">GI 부담 관리(가중치/자동튜닝)</div>
                        <div className="grid grid-cols-3 gap-2 text-xs">
                          {Object.keys(giWeights).map(k=> (
                            <div key={k}>
                              <div className="mb-1">{FOODS[k].name}</div>
                              <input type="range" min={0} max={1} step={0.05} value={giWeights[k]} onChange={(e)=> setGiWeights({...giWeights, [k]: parseFloat(e.target.value)})} />
                              <div>{giWeights[k]}</div>
                            </div>
                          ))}
                        </div>
                        <div className="mt-3 flex items-center gap-2">
                          <input id="giauto" type="checkbox" checked={giAutoTune} onChange={(e)=>setGiAutoTune(e.target.checked)} />
                          <label htmlFor="giauto" className="text-sm">자동 튜닝 활성화</label>
                        </div>
                        <div className="text-xs text-slate-500 mt-1">* 점수↑ → 꿀↓, 밥↑로 미세 조정</div>
                      </div>
                    </div>
                  </Section>
                );

                if (id === "sources") return (
                  <Section key={id} id={id} title="단백질/지방 식품 선택 & 세션 연동">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm mb-1">단백질원</label>
                        <select value={pSource} onChange={(e)=>setPSource(e.target.value)} className="w-full border rounded-xl px-3 py-2 mb-3">
                          {P_SOURCES.map(o=> <option key={o.key} value={o.key}>{o.label}</option>)}
                        </select>
                        <label className="block text-sm mb-1">지방원</label>
                        <select value={fSource} onChange={(e)=>setFSource(e.target.value)} className="w-full border rounded-xl px-3 py-2">
                          {F_SOURCES.map(o=> <option key={o.key} value={o.key}>{o.label}</option>)}
                        </select>
                      </div>
                      <div className="p-3 rounded-xl bg-slate-50">
                        <div className="text-sm font-semibold mb-2">세션 입력(AM/PM)</div>
                        {sessions.map((s,idx)=> (
                          <div key={s.id} className="grid grid-cols-4 gap-2 items-center mb-2">
                            <div className="text-xs">{s.id}</div>
                            <select value={s.type} onChange={(e)=>{
                              const v = e.target.value; const next = [...sessions]; next[idx] = {...s, type: v}; setSessions(next);
                            }} className="border rounded px-2 py-1 text-sm">
                              {['하체','상체','전신'].map(t=> <option key={t} value={t}>{t}</option>)}
                            </select>
                            <input className="border rounded px-2 py-1 text-sm" value={s.minutes} onChange={(e)=>{
                              const v = parseInt(e.target.value||'0'); const next = [...sessions]; next[idx] = {...s, minutes: clamp(v,0,240)}; setSessions(next);
                            }} />
                            <select value={s.RPE} onChange={(e)=>{
                              const v = parseInt(e.target.value); const next = [...sessions]; next[idx] = {...s, RPE: v}; setSessions(next);
                            }} className="border rounded px-2 py-1 text-sm">
                              {[6,7,8,9].map(n=> <option key={n} value={n}>RPE {n}</option>)}
                            </select>
                          </div>
                        ))}
                      </div>
                    </div>
                  </Section>
                );

                if (id === "split_stage") return (
                  <Section key={id} id={id} title="끼니 배분 & D-day 무대">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div>
                        <label className="block text-sm mb-1">배분 프로파일</label>
                        <select value={mealSplitKey} onChange={(e)=>setMealSplitKey(e.target.value)} className="w-full border rounded-xl px-3 py-2">
                          {MEAL_SPLITS.map(m=> <option key={m.key} value={m.key}>{m.label}</option>)}
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm mb-1">D-day 무대 시간</label>
                        <input type="time" value={stageTime} onChange={(e)=>setStageTime(e.target.value)} className="w-full border rounded-xl px-3 py-2" />
                        <div className="text-xs text-slate-500 mt-1">무대 90/45/15분 전 퀵카브 가이드 생성</div>
                      </div>
                      <div className="text-xs text-slate-500">세션이 있으면 자동으로 운동 전후 집중 배분을 우선 적용합니다.</div>
                    </div>
                  </Section>
                );

                if (id === "summary") return (
                  <Section key={id} id={id} title="권장 섭취량 (하루) & 전해질">
                    <div className="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm">
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">단계</div><div className="font-semibold">{labelForPhase(phase)}</div></div>
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">탄수</div><div className="font-semibold">{round2(carb_g_target)} g</div></div>
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">단백질</div><div className="font-semibold">{round2(protein_g_target)} g</div></div>
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">지방</div><div className="font-semibold">{round2(finalTotals.F)} g</div></div>
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">총 열량</div><div className="font-semibold">{round2(finalKcal)} kcal</div></div>
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">수분(권장)</div><div className="font-semibold">{round2(water_ml/1000)} L</div>{water_guard && <div className="text-xs text-amber-700 mt-1">경고: 최저 가드레일 미만</div>}</div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm mt-3">
                      <div className="bg-blue-50 rounded-xl p-3"><div className="text-blue-700">나트륨(권장)</div><div className="font-semibold">{Math.round(sodium_mg)} mg</div><div className="text-xs text-blue-700 mt-1">칼륨(추정): {potassium_mg} mg</div></div>
                      <div className="bg-slate-50 rounded-xl p-3"><div className="text-slate-700">탄수 식품 그램</div>
                        <div>가래떡: <b>{round2(gramsCarbFoods.garaetteok)} g</b></div>
                        <div>흰쌀밥: <b>{round2(gramsCarbFoods.rice)} g</b></div>
                        <div>밤꿀: <b>{round2(gramsCarbFoods.honey)} g</b></div>
                      </div>
                      <div className="bg-amber-50 rounded-xl p-3"><div className="text-amber-700">YAZIO 모드</div>
                        <div className="flex items-center gap-2 mt-1"><input type="checkbox" checked={yazioMode} onChange={(e)=>setYazioMode(e.target.checked)} /><span className="text-sm">활성화</span></div>
                        {yazioMode && (
                          <div className="grid grid-cols-4 gap-2 mt-2 text-xs">
                            <div><label className="block text-xs mb-1">tol C (g)</label><input className="w-full border rounded px-2 py-1 text-sm" value={tolC.str} onChange={tolC.onChange} onBlur={tolC.onBlur} /></div>
                            <div><label className="block text-xs mb-1">tol P (g)</label><input className="w-full border rounded px-2 py-1 text-sm" value={tolP.str} onChange={tolP.onChange} onBlur={tolP.onBlur} /></div>
                            <div><label className="block text-xs mb-1">tol F (g)</label><input className="w-full border rounded px-2 py-1 text-sm" value={tolF.str} onChange={tolF.onChange} onBlur={tolF.onBlur} /></div>
                            <div><label className="block text-xs mb-1">tol kcal</label><input className="w-full border rounded px-2 py-1 text-sm" value={tolKcal.str} onChange={tolKcal.onChange} onBlur={tolKcal.onBlur} /></div>
                          </div>
                        )}
                      </div>
                    </div>
                  </Section>
                );

                if (id === "meals") return (
                  <Section key={id} id={id} title="하루 4끼 식단 + 전해질">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-left text-slate-500">
                            <th className="py-2">끼니</th>
                            <th>가래떡 (g)</th>
                            <th>흰쌀밥 (g)</th>
                            <th>밤꿀 (g)</th>
                            <th>{FOODS[pSource].name} (g)</th>
                            <th>{FOODS[fSource].name} (g)</th>
                            <th>Na (mg)</th>
                            <th>K (mg)</th>
                            <th>kcal</th>
                          </tr>
                        </thead>
                        <tbody>
                          {meals.map((m)=> (
                            <tr key={m.name} className="border-t">
                              <td className="py-2 font-medium">{m.name}</td>
                              <td>{round2(m.grams.garaetteok)}</td>
                              <td>{round2(m.grams.rice)}</td>
                              <td>{round2(m.grams.honey)}</td>
                              <td>{round2(m.grams.pFood)}</td>
                              <td>{round2(m.grams.fFood)}</td>
                              <td>{round2(m.Na)}</td>
                              <td>{round2(m.K)}</td>
                              <td>{round2(m.kcal)}</td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </Section>
                );

                if (id === "quickcarb") return (
                  <Section key={id} id={id} title="D-day 퀵 카브 플랜">
                    <div className="text-sm">총 퀵카브 권장: <b>{round2(quickCarbPlan.totalQuick)} g</b> (≈ 0.3 g/kg)</div>
                    <table className="w-full text-sm mt-2">
                      <thead><tr className="text-left text-slate-500"><th className="py-2">시점</th><th>밤꿀(g)</th><th>가래떡(g)</th><th>탄수 합(g)</th></tr></thead>
                      <tbody>
                        {quickCarbPlan.items.map(it=> (
                          <tr key={it.tmin} className="border-t"><td className="py-2">{it.tmin}분 전</td><td>{round2(it.honey_g)}</td><td>{round2(it.garae_g)}</td><td>{round2(it.carb)}</td></tr>
                        ))}
                      </tbody>
                    </table>
                  </Section>
                );

                if (id === "diagnostics") return (
                  <Section key={id} id={id} title="검산/진단 & 피드백 루프">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">이론 kcal</div><div className="font-semibold">{round2(total_kcal_target)} kcal</div></div>
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">식품 합 kcal</div><div className="font-semibold">{round2(finalKcal)} kcal</div></div>
                      <div className="rounded-xl p-3 bg-slate-50"><div className="text-slate-500 text-sm">차이</div><div className="font-semibold">{round2((finalKcal-total_kcal_target))} kcal ({round2(((finalKcal-total_kcal_target)/Math.max(1,total_kcal_target))*100)}%)</div></div>
                    </div>
                  </Section>
                );

                if (id === "week") return (
                  <Section key={id} id={id} title="D-8 ~ D-day 주간 미리보기">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="text-left text-slate-500">
                            <th className="py-2">일자</th>
                            <th>단계</th>
                            <th>탄수(g)</th>
                            <th>단백질(g)</th>
                            <th>지방(g)</th>
                            <th>총 kcal</th>
                          </tr>
                        </thead>
                        <tbody>
                          {DAY_OPTIONS.map((opt) => {
                            const ph = phaseForDay(opt.key);
                            const dflt = defaultsByPhase(ph, profile);
                            const gPer = dflt.carb_g_per;
                            const cKind = dflt.carbKind;
                            const carb = (cKind === "perLBM" ? LBM : weight) * gPer;
                            const P = LBM * proteinLevel;
                            const Pk = P * 4, Ck = carb * 4, Fk = (dflt.fat_pct / (1 - dflt.fat_pct)) * (Pk + Ck);
                            const F = Fk / 9;
                            const K = Pk + Ck + Fk;
                            return (
                              <tr key={opt.key} className="border-t">
                                <td className="py-2">{opt.label}</td>
                                <td>{labelForPhase(ph)}</td>
                                <td>{round2(carb)}</td>
                                <td>{round2(P)}</td>
                                <td>{round2(F)}</td>
                                <td>{round2(K)}</td>
                              </tr>
                            );
                          })}
                        </tbody>
                      </table>
                    </div>
                  </Section>
                );

                if (id === "viz") return (
                  <Section key={id} id={id} title="시각화 대시보드">
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      <div className="rounded-2xl border bg-white p-4">
                        <div className="font-semibold mb-2">오늘 매크로 도넛 (kcal 기준)</div>
                        <div style={{ width: "100%", height: 240 }}>
                          <ResponsiveContainer width="100%" height={240}>
                            <PieChart>
                              <Pie data={[
                                { name: "탄수", value: finalTotals.C * 4 },
                                { name: "단백질", value: finalTotals.P * 4 },
                                { name: "지방", value: finalTotals.F * 9 },
                              ]} dataKey="value" nameKey="name" outerRadius={90} label>
                                <Cell fill="#60a5fa" /><Cell fill="#34d399" /><Cell fill="#f59e0b" />
                              </Pie>
                              <Tooltip />
                            </PieChart>
                          </ResponsiveContainer>
                        </div>
                      </div>

                      <div className="rounded-2xl border bg-white p-4">
                        <div className="font-semibold mb-2">D-8→D-day 매크로 타임라인 (g)</div>
                        <div style={{ width: "100%", height: 260 }}>
                          <ResponsiveContainer width="100%" height={260}>
                            <BarChart data={DAY_OPTIONS.map((opt)=>{
                              const ph = phaseForDay(opt.key);
                              const dflt = defaultsByPhase(ph, profile);
                              const gPer = dflt.carb_g_per;
                              const cKind = dflt.carbKind;
                              const C = (cKind === "perLBM" ? LBM : weight) * gPer;
                              const P = LBM * proteinLevel;
                              const Pk = P * 4, Ck = C * 4, Fk = (dflt.fat_pct / (1 - dflt.fat_pct)) * (Pk + Ck);
                              const F = Fk / 9;
                              return { day: opt.label, C, P, F };
                            })}>
                              <CartesianGrid strokeDasharray="3 3" />
                              <XAxis dataKey="day" />
                              <YAxis />
                              <Tooltip />
                              <Legend />
                              <Bar dataKey="C" name="탄수(g)" fill="#60a5fa" stackId="a" />
                              <Bar dataKey="P" name="단백질(g)" fill="#34d399" stackId="a" />
                              <Bar dataKey="F" name="지방(g)" fill="#f59e0b" stackId="a" />
                            </BarChart>
                          </ResponsiveContainer>
                        </div>
                      </div>
                    </div>
                  </Section>
                );

                if (id === "options") return (
                  <Section key={id} id={id} title="옵션(가드레일·규칙표·보충제)">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="p-3 rounded-xl bg-slate-50">
                        <div className="text-sm font-semibold mb-2">물 섭취 가드레일</div>
                        <div><label className="block text-xs mb-1">최저선 mL/kg</label><input className="w-full border rounded px-2 py-1 text-sm" value={minWater_ml_per_kg.str} onChange={minWater_ml_per_kg.onChange} onBlur={minWater_ml_per_kg.onBlur} /></div>
                        {water_guard && <div className="mt-2 text-xs text-amber-700">경고: 현재 권장치가 최저선 미만</div>}
                      </div>
                      <div className="p-3 rounded-xl bg-slate-50">
                        <div className="text-sm font-semibold mb-2">날짜별 규칙표 (kg당)</div>
                        {Object.entries(rulesByDay).map(([k,v])=> (
                          <div key={k} className="grid grid-cols-3 gap-2 items-end mb-2 text-xs">
                            <div className="font-medium">{labelForPhase(k)}</div>
                            <input className="border rounded px-2 py-1" value={v.water_ml_per_kg} onChange={(e)=> setRulesByDay({ ...rulesByDay, [k]: { ...v, water_ml_per_kg: clamp(parseInt(e.target.value||'0'), 10, 80) } })} />
                            <input className="border rounded px-2 py-1" value={v.sodium_mg_per_kg} onChange={(e)=> setRulesByDay({ ...rulesByDay, [k]: { ...v, sodium_mg_per_kg: clamp(parseInt(e.target.value||'0'), 10, 100) } })} />
                            <div className="col-span-3 text-[11px] text-slate-500">물(mL/kg), Na(mg/kg)</div>
                          </div>
                        ))}
                      </div>
                      <div className="p-3 rounded-xl bg-slate-50">
                        <div className="text-sm font-semibold mb-2">보충제 스케줄러</div>
                        {suppPlan.map((s,idx)=> (
                          <div key={idx} className="grid grid-cols-5 gap-2 items-center text-xs mb-2">
                            <input type="checkbox" checked={s.enable} onChange={(e)=>{ const next=[...suppPlan]; next[idx] = {...s, enable:e.target.checked}; setSuppPlan(next); }} />
                            <div className="col-span-2">{s.name}</div>
                            <div className="col-span-2">{s.timing} — {s.note}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  </Section>
                );

                if (id === "export") return (
                  <Section key={id} id={id} title="내보내기 / 스냅샷">
                    <div className="flex flex-wrap gap-2 text-sm">
                      <button className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" onClick={()=> download("peakweek_yazio.txt", buildYazioText())}>YAZIO용 텍스트</button>
                      <button className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" onClick={exportCSV}>CSV</button>
                      <button className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" onClick={exportJSON}>JSON</button>
                      <button className="px-3 py-2 rounded-xl bg-gray-100 hover:bg-gray-200" onClick={saveSnapshot}>스냅샷 저장</button>
                    </div>
                    <div className="mt-3 text-xs">
                      <div className="font-semibold mb-1">스냅샷 (최근 20개)</div>
                      <ul className="space-y-1">
                        {snapshots.map((s, i)=> (
                          <li key={i} className="px-2 py-1 rounded bg-slate-100">{s.ts} — P{round2(s.totals.P)} C{round2(s.totals.C)} F{round2(s.totals.F)}</li>
                        ))}
                      </ul>
                    </div>
                  </Section>
                );

                return null;
              })}

              <div className="text-[11px] text-slate-500 mt-6">
                <p>주의: 피크위크는 개인 반응 차가 큽니다. 본 도구는 기본값/검산/가드레일 제공을 목적으로 하며, 실제 적용 시 컨디션·인바디 업데이트를 반영해 미세 조정하세요.</p>
              </div>
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<PeakWeekCalculator_V12 />);
    </script>
  </body>
</html>
